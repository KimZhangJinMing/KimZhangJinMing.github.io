<!DOCTYPE html>





<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="generator" content="Hexo 3.9.0">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/Slippers_32x32.png?v=7.3.0">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/Slippers_16x16.png?v=7.3.0">
  <link rel="mask-icon" href="/images/logo.svg?v=7.3.0" color="#222">

<link rel="stylesheet" href="/css/main.css?v=7.3.0">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css?v=4.7.0">
  <link rel="stylesheet" href="/lib/fancybox/source/jquery.fancybox.css">
  <link rel="stylesheet" href="/lib/needsharebutton/needsharebutton.css">
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link rel="stylesheet" href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.3.0',
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":true},
    save_scroll: false,
    copycode: {"enable":true,"show_result":true,"style":null},
    fancybox: true,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},
    path: 'search.xml',
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    }
  };
</script>
<script>
    (function () {
        if ('') {
            if (prompt('请输入文章密码') !== '') {
                alert('密码错误！');
                if (history.length === 1) {
                    location.replace("http://xxxxxxx.xxx"); // 这里替换成你的首页地址
                } else {
                    history.back();
                }
            }
        }
    })();
</script>

  <meta name="description" content="[TOC] 微服务架构理论入门微服务概念 提倡将单一应用程序拆分成一组小的服务  每个服务都是一个SpringBoot应用   SpringCloud概念 分布式微服务架构的一站式解决方案  版本选型由SpringCloud版本决定SpringBoot版本。 SpringBoot版本选型 springBoot官方强烈建议使用2.0以上版本 2.2.2.RELEASE  SpringCloud版本选">
<meta name="keywords" content="Java,SSM,大学生活">
<meta property="og:type" content="article">
<meta property="og:title" content="kim.zhang">
<meta property="og:url" content="http://www.zhang.kim/2021/11/21/Spring Cloud/Spring Cloud/index.html">
<meta property="og:site_name" content="kim.zhang">
<meta property="og:description" content="[TOC] 微服务架构理论入门微服务概念 提倡将单一应用程序拆分成一组小的服务  每个服务都是一个SpringBoot应用   SpringCloud概念 分布式微服务架构的一站式解决方案  版本选型由SpringCloud版本决定SpringBoot版本。 SpringBoot版本选型 springBoot官方强烈建议使用2.0以上版本 2.2.2.RELEASE  SpringCloud版本选">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211204645960.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211204742180.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211213212548.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201219203141782.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201219222958331.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211222400955.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211230437404.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211234341772.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212110342536.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212110414933.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212131113323.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212131502623.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212131557705.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212134024996.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212140312487.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212153620657.png">
<meta property="og:image" content="c:%5CUsers%5Czjm16%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201213163211853.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201219142706651.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201219235538034.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220003426084.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220153356198.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220160328224.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220160757195.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220164008117.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221194659396.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221195103011.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221203317319.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221202509643.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221204841920.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221205245234.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221205446832.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221205756914.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221205920721.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221210119238.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222200953755.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222201255069.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222203120210.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222203702580.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222204548485.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222205812768.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201223205817336.png">
<meta property="og:image" content="c:%5CUsers%5Czjm16%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201224223359921.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201228214652142.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201228214951974.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201228215112833.png">
<meta property="og:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201228215401610.png">
<meta property="og:updated_time" content="2021-11-21T04:56:33.443Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="kim.zhang">
<meta name="twitter:description" content="[TOC] 微服务架构理论入门微服务概念 提倡将单一应用程序拆分成一组小的服务  每个服务都是一个SpringBoot应用   SpringCloud概念 分布式微服务架构的一站式解决方案  版本选型由SpringCloud版本决定SpringBoot版本。 SpringBoot版本选型 springBoot官方强烈建议使用2.0以上版本 2.2.2.RELEASE  SpringCloud版本选">
<meta name="twitter:image" content="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211204645960.png">
  <link rel="canonical" href="http://www.zhang.kim/2021/11/21/Spring Cloud/Spring Cloud/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: false,
    isPost: true,
    isPage: false,
    isArchive: false
  };
</script>

  <title> | kim.zhang</title>
  








  <noscript>
  <style>
  .use-motion .motion-element,
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-title { opacity: initial; }

  .use-motion .logo,
  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  <div class="container sidebar-position-left">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta">

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">kim.zhang</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">风在前，无惧!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
      
      
      
        
        <li class="menu-item menu-item-home">
      
    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-tags">
      
    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">42</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-categories">
      
    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">12</span></a>

  </li>
      
      
      
        
        <li class="menu-item menu-item-archives">
      
    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">94</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a href="javascript:;" class="popup-trigger">
        
          <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
      </li>
    
  </ul>

    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>


    </div>
</nav>
</div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
            

          <div id="content" class="content page-post-detail">
            

  <div id="posts" class="posts-expand">
    
    <div class="reading-progress-bar"></div>

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://www.zhang.kim/2021/11/21/Spring Cloud/Spring Cloud/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Kim.Zhang">
      <meta itemprop="description" content="且行且珍惜">
      <meta itemprop="image" content="/images/1.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="kim.zhang">
    </span>
      <header class="post-header">

        
          <h1 class="post-title" itemprop="name headline">

            
          </h1>
        

        <div class="post-meta">

          
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              
                
              

              <time title="创建时间：2021-11-21 12:56:33" itemprop="dateCreated datePublished" datetime="2021-11-21T12:56:33+08:00">2021-11-21</time>
            </span>
          

          
          <br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="fa fa-file-word-o"></i>
              </span>
              
                <span class="post-meta-item-text">本文字数：</span>
              
              <span>64k</span>
            </span>
          
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="fa fa-clock-o"></i>
              </span>
              
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              
              <span>58 分钟</span>
            </span>
          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>[TOC]</p>
<h3 id="微服务架构理论入门"><a href="#微服务架构理论入门" class="headerlink" title="微服务架构理论入门"></a>微服务架构理论入门</h3><h4 id="微服务概念"><a href="#微服务概念" class="headerlink" title="微服务概念"></a>微服务概念</h4><ul>
<li><p>提倡将单一应用程序拆分成一组小的服务</p>
</li>
<li><p>每个服务都是一个SpringBoot应用</p>
</li>
</ul>
<h4 id="SpringCloud概念"><a href="#SpringCloud概念" class="headerlink" title="SpringCloud概念"></a>SpringCloud概念</h4><ul>
<li>分布式微服务架构的一站式解决方案</li>
</ul>
<h4 id="版本选型"><a href="#版本选型" class="headerlink" title="版本选型"></a>版本选型</h4><p><strong>由SpringCloud版本决定SpringBoot版本。</strong></p>
<h5 id="SpringBoot版本选型"><a href="#SpringBoot版本选型" class="headerlink" title="SpringBoot版本选型"></a>SpringBoot版本选型</h5><ul>
<li>springBoot官方强烈建议使用2.0以上版本</li>
<li>2.2.2.RELEASE</li>
</ul>
<h5 id="SpringCloud版本选型"><a href="#SpringCloud版本选型" class="headerlink" title="SpringCloud版本选型"></a>SpringCloud版本选型</h5><ul>
<li><p>springCloud H版本对应SpringBoot2.2.x版本</p>
</li>
<li><p>Hoxton.SR1</p>
</li>
<li><p>Clond Alibaba 2.1.0.RELEASE</p>
</li>
</ul>
<h3 id="停更的影响"><a href="#停更的影响" class="headerlink" title="停更的影响"></a>停更的影响</h3><ul>
<li>服务注册中心<ul>
<li>Eureka(×)</li>
<li>Zookeeper(✔)</li>
<li>Consul(✔)</li>
<li>Nacos(✔)</li>
</ul>
</li>
<li>服务调用<ul>
<li>Ribbon</li>
<li>LoadBalancer(✔)</li>
<li>Feign(x)</li>
<li>OpenFeign(✔)</li>
</ul>
</li>
<li>服务降级<ul>
<li>Hystrix(x)</li>
<li>Reslience4j(✔)</li>
<li>Sentinenl(✔ 国内使用)</li>
</ul>
</li>
<li>服务网关<ul>
<li>Zuul(x)</li>
<li>Gateway(✔)</li>
</ul>
</li>
<li>服务配置<ul>
<li>Config(x)</li>
<li>Nacos(✔)</li>
</ul>
</li>
<li>服务总线<ul>
<li>Bus(x)</li>
<li>Nacos(✔)</li>
</ul>
</li>
</ul>
<h3 id="工程搭建"><a href="#工程搭建" class="headerlink" title="工程搭建"></a>工程搭建</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">packaging</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="dependencyManagement"><a href="#dependencyManagement" class="headerlink" title="dependencyManagement"></a>dependencyManagement</h4><ul>
<li>出现在最顶层的父POM文件中</li>
<li>锁定版本，子POM不需要指定版本号就可以使用父POM的版本号，子POM不需要写groupid和version</li>
<li>如果子POM指定了具体的版本号，使用子POM的版本号</li>
<li>只是声明依赖，并不引入，子POM需要显示声明需要用的依赖 </li>
</ul>
<h4 id="基础pom-xml"><a href="#基础pom-xml" class="headerlink" title="基础pom.xml"></a>基础pom.xml</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- SpringCloud alibaba nacos--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--mysql-connector-java--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--jdbc--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-jdbc<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--热部署--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="微服务模块创建"><a href="#微服务模块创建" class="headerlink" title="微服务模块创建"></a>微服务模块创建</h4><ul>
<li>创建module(创建完成回到父工程POM查看变化)</li>
<li>修改pom.xml</li>
<li>写配置文件yml</li>
<li>写启动类</li>
<li>写业务类</li>
</ul>
<h4 id="mybatis-mapper文件模板"><a href="#mybatis-mapper文件模板" class="headerlink" title="mybatis mapper文件模板"></a>mybatis mapper文件模板</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8" ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">mapper</span> <span class="meta-keyword">PUBLIC</span> <span class="meta-string">"-//mybatis.org//DTD Mapper 3.0//EN"</span></span></span><br><span class="line"><span class="meta">        <span class="meta-string">"http://mybatis.org/dtd/mybatis-3-mapper.dtd"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sise.cloud.dao.StorageDao"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="构建时的几个小坑"><a href="#构建时的几个小坑" class="headerlink" title="构建时的几个小坑"></a>构建时的几个小坑</h4><ul>
<li><p>使用mybatis时，可以在启动类上标记注解@MapperScan来注入Dao，也可以直接在Dao上标记@Mappee注解来将Dao加入到容器中（不推荐使用@Repository，在插入时有时候会出现问题）</p>
</li>
<li><p>mapper.xml的namespace应该与Dao对应</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">"com.sise.cloud.dao.PaymentDao"</span>&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>mybatis的配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="comment"># mapper.xml存放位置</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="comment"># 实体类不用写全限定类名</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.sise.cloud.model</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>mybatis插入时返回主键的写法：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">insert</span> <span class="attr">id</span>=<span class="string">"create"</span> <span class="attr">useGeneratedKeys</span>=<span class="string">"true"</span> <span class="attr">keyProperty</span>=<span class="string">"id"</span> <span class="attr">parameterType</span>=<span class="string">"Payment"</span>&gt;</span></span><br><span class="line">      insert into payment(serial) values( #&#123;serial&#125; )</span><br><span class="line"><span class="tag">&lt;/<span class="name">insert</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>返回的主键在对应实体的keyProperty中，而不是方法的返回值。方法的返回值是影响行数。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@PostMapping</span>(<span class="string">"/create"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult&lt;Long&gt; <span class="title">create</span><span class="params">(@RequestBody  Payment payment)</span></span>&#123;</span><br><span class="line">    Integer row = paymentService.create(payment);</span><br><span class="line">    <span class="keyword">return</span> row != <span class="keyword">null</span> ? <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">200</span>,<span class="string">"ok"</span>, payment.getId())</span><br><span class="line">        : <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">500</span>,<span class="string">"create error"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>datasource配置：</p>
<p><strong>注意serverTimezone的大小写。</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 当前数据库操作类型</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mcloud?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>post方法传递json数据时，后端记得加上@RequestBody注解</p>
</li>
</ul>
<h4 id="devtool热部署"><a href="#devtool热部署" class="headerlink" title="devtool热部署"></a>devtool热部署</h4><ol>
<li>添加maven依赖(子POM)</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在pom文件中添加maven-plugin(父POM)</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.maven.plugins<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>maven-compiler-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">source</span>&gt;</span>8<span class="tag">&lt;/<span class="name">source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">target</span>&gt;</span>8<span class="tag">&lt;/<span class="name">target</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>enabling automatic build</li>
</ol>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211204645960.png" alt="image-热部署idea设置"></p>
<ol start="4">
<li>ctrl + shift + alt + /</li>
</ol>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211204742180.png" alt="image-registry设置"></p>
<h4 id="Run-Dashboard的配置"><a href="#Run-Dashboard的配置" class="headerlink" title="Run Dashboard的配置"></a>Run Dashboard的配置</h4><p><strong>在项目的存放路径下.idea目录下，有一个workspace.xml，找到RunDashboard的选项，添加配置</strong></p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">component</span> <span class="attr">name</span>=<span class="string">"RunDashboard"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">"configurationTypes"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">option</span> <span class="attr">value</span>=<span class="string">"SpringBootApplicationConfigurationType"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">"ruleStates"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">list</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RuleState</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"ConfigurationTypeDashboardGroupingRule"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">RuleState</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">RuleState</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">option</span> <span class="attr">name</span>=<span class="string">"name"</span> <span class="attr">value</span>=<span class="string">"StatusDashboardGroupingRule"</span> /&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">RuleState</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">list</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">option</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">component</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>重启idea后，再次run项目就出现了。</p>
<h4 id="maven出现KIX-path-building-failed"><a href="#maven出现KIX-path-building-failed" class="headerlink" title="maven出现KIX path building failed"></a>maven出现KIX path building failed</h4><p>idea maven设置添加参数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">-DarchetypeCatalog=internal -Dmaven.wagon.http.ssl.insecure=<span class="keyword">true</span> -Dmaven.wagon.http.ssl.allowall=<span class="keyword">true</span></span><br></pre></td></tr></table></figure>

<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211213212548.png" alt="image-maven设置"></p>
<h4 id="抽取出公用的api和实体类"><a href="#抽取出公用的api和实体类" class="headerlink" title="抽取出公用的api和实体类"></a>抽取出公用的api和实体类</h4><ul>
<li>新建一个moduel：cloud-api-common</li>
<li>将多个模块重复的代码抽取到这个模块</li>
<li>maven clean instll ，将公用模块发布到仓库</li>
<li>其他module引入公用模块的坐标</li>
</ul>
<h4 id="80端口被占用"><a href="#80端口被占用" class="headerlink" title="80端口被占用"></a>80端口被占用</h4><p>在window上，80端口被占用的2种情况：</p>
<ul>
<li>SQL Server Reporting Services (MSSQLSERVER) ，SQL Server的日志系统</li>
<li>IIS服务</li>
</ul>
<p>解决方法（SQL Server Reporting Services ）：</p>
<ol>
<li>使用命令netstat -ano|findstr 80查找使用80端口的程序，可以看到是pid=4的的程序</li>
<li>使用命令tasklist列出当前运行的所有线程，可以看到pid=4的程序竟然是system</li>
<li>使用命名services.msc进入服务端口，找到SQL Server Reporting Services (MSSQLSERVER)，终止</li>
</ol>
<p>解决方法（IIS）:</p>
<ol>
<li>使用管理员身份运行cmd</li>
<li>使用net stop http停止http服务</li>
<li>sc config http start= disabled  <strong>注意，=后面的空格不可少</strong></li>
</ol>
<h4 id="linux安装wget"><a href="#linux安装wget" class="headerlink" title="linux安装wget"></a>linux安装wget</h4><ol>
<li>linux查看版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>根据linux版本下载wget命令</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http://ftp.sjtu.edu.cn/centos/7/os/x86_64/Packages/</span><br><span class="line">下载wget-1.14-18.el7_6.1.x86_64.rpm   </span><br><span class="line">上传到阿里云服务器</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>安装wget</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -vih wget-1.14-18.el7_6.1.x86_64.rpm</span><br></pre></td></tr></table></figure>

<p>如果已经安装了wget，还提示wget command is not found？ </p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"> 1.执行以下命令查询wge命令的路径</span></span><br><span class="line">whereis wge</span><br><span class="line"><span class="meta">#</span><span class="bash"> 系统返回以下信息。</span></span><br><span class="line">wge：/usr/bin/wge</span><br><span class="line"><span class="meta">#</span><span class="bash"> 2.根据上述的路径，执行以下命令重命名即可。</span></span><br><span class="line">cp /usr/bin/wge /usr/bin/wget</span><br></pre></td></tr></table></figure>

<h4 id="linux配置网卡"><a href="#linux配置网卡" class="headerlink" title="linux配置网卡"></a>linux配置网卡</h4><ol>
<li><p>使用ipconfig查看ip信息</p>
</li>
<li><p>vim /etc/sysconfig/network-scripts/ifcfg-eth0</p>
</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">DEVICE=eth0</span><br><span class="line">BOOTPROTO=none</span><br><span class="line">ONBOOT=yes</span><br><span class="line">ARPCHECK=no</span><br><span class="line">IPADDR=172.16.47.149</span><br><span class="line">NETMASK=255.255.240.0</span><br><span class="line">GATEWAY=172.16.47.253</span><br></pre></td></tr></table></figure>

<h4 id="yum"><a href="#yum" class="headerlink" title="yum"></a>yum</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 查询包安装的位置</span><br><span class="line">rpm -ql 包名</span><br><span class="line"># 查询所有已经安装的包</span><br><span class="line">rpm  -qa  </span><br><span class="line"># 查询包是否安装</span><br><span class="line">rpm  -q</span><br></pre></td></tr></table></figure>

<h4 id="修改阿里的yum源"><a href="#修改阿里的yum源" class="headerlink" title="修改阿里的yum源"></a>修改阿里的yum源</h4><ol>
<li>首先备份系统自带yum源配置文件/etc/yum.repos.d/CentOS-Base.repo</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>查看centos版本</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">lsb_release -a</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>下载yum源配置文件到/etc/yum.repos.d</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash">CentOS7</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-7.repo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">CentOS6</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-6.repo</span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">CentOS5</span></span><br><span class="line">wget -O /etc/yum.repos.d/CentOS-Base.repo http://mirrors.aliyun.com/repo/Centos-5.repo</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>运行yum makecache生成缓存</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum clean all</span><br><span class="line">yum makecache</span><br></pre></td></tr></table></figure>

<h4 id="linux安装JDK"><a href="#linux安装JDK" class="headerlink" title="linux安装JDK"></a>linux安装JDK</h4><ol>
<li><p>下载rpm包，上传到linux服务器</p>
</li>
<li><p>rpm -ivh 安装包</p>
</li>
<li><p>rpm -qa | grep jdk 查找当前系统中安装的JDK包</p>
</li>
<li><p>rpm -ql jdk包名 | grep bin 查找JDK安装的目录</p>
</li>
<li><p>配置环境变量vim /etc/profile</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">export JAVA_HOME=/usr/java/jdk1.8.0_271-amd64</span><br><span class="line">export CLASSPATH=.:$JAVA_HOME/lib/dt.jar:$JAVA_HOME/lib/tools.jar</span><br><span class="line">export PATH=$PATH:$JAVA_HOME/bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>测试查看JDK版本  java  javac</p>
</li>
</ol>
<h4 id="linux安装maven"><a href="#linux安装maven" class="headerlink" title="linux安装maven"></a>linux安装maven</h4><ol>
<li><p>打开maven的官网下载页，找到tar.gz压缩包，然后右键选择【复制链接地址】</p>
</li>
<li><p>回到Linux服务器中，创建一个maven目录，使用<code>wget</code>命令将复制的链接进行下载。</p>
</li>
<li><p>然后使用命令<code>tar -zxvf apache-maven-3.6.0-bin.tar.gz</code>，将压缩包进行解压，解压后我们会得到一个 <code>apache-maven-3.6.0</code>目录。</p>
</li>
<li><p>我们cd进入到 <code>apache-maven-3.6.0</code>目录，然后执行命令<code>pwd</code>，显示maven的绝对路径。然后复制该路径</p>
</li>
<li><p>执行命令<code>vim /etc/profile</code>编辑环境变量文件。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export MAVEN_HOME=/root/app/maven/apache-maven-3.6.0</span><br></pre></td></tr></table></figure>
</li>
<li><p>将MAVEN_HOME追加到PATH环境变量中</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">export PATH=$PATH:$JAVA_HOME/bin:$MAVEN_HOME/bin</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行<code>source /etc/profile</code>命令来更新刚才的配置。</p>
</li>
<li><p>执行命令<code>mvn -version</code>查看maven是否安装配置成功。</p>
</li>
</ol>
<h4 id="linux安装rabbitMQ"><a href="#linux安装rabbitMQ" class="headerlink" title="linux安装rabbitMQ"></a>linux安装rabbitMQ</h4><ol>
<li>安装erlang,添加源vim /etc/yum.repos.d/erlang-solutions.repo</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[erlang-solutions]</span><br><span class="line">name=CentOS $releasever - $basearch - Erlang Solutions</span><br><span class="line">baseurl=https://packages.erlang-solutions.com/rpm/centos/$releasever/$basearch</span><br><span class="line">gpgcheck=1</span><br><span class="line">gpgkey=https://packages.erlang-solutions.com/rpm/erlang_solutions.asc</span><br><span class="line">enabled=1</span><br></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm --import https://packages.erlang-solutions.com/rpm/erlang_solutions.asc</span><br></pre></td></tr></table></figure>

<p>安装erlang：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install erlang -y</span><br></pre></td></tr></table></figure>

<p>验证是否安装成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">erl -version</span><br></pre></td></tr></table></figure>

<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201219203141782.png" alt="image-查看erlang版本"></p>
<ol start="2">
<li>安装rabbitMQ</li>
</ol>
<p>下载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://github.com/rabbitmq/rabbitmq-server/releases/download/v3.7.14/rabbitmq-server-3.7.14-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y rabbitmq-server-3.7.13-1.el7.noarch.rpm</span><br><span class="line">rpm -ivh rabbitmq-server-3.7.13-1.el7.noarch.rpm</span><br></pre></td></tr></table></figure>

<p>安装过程中如果出现错误：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed dependencies: 	socat is needed by rabbitmq-server-3.7.14-1.el7.noarch</span><br></pre></td></tr></table></figure>

<p>执行命令：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install socat</span><br></pre></td></tr></table></figure>

<p>安装完成后在/usr/sbin目录下有4个关于rabbitMQ的命令：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201219222958331.png" alt="image-rabbitMQ命令"></p>
<ol start="3">
<li>启动rabbitMQ</li>
</ol>
<blockquote>
<p>rabbitmq-server start，当然也可以使用 rabbitmqctl statr_app 来启动</p>
</blockquote>
<ol start="4">
<li>开启rabbitMQ界面管理</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rabbitmq-plugins enable rabbitmq_management</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>添加账号，授权远程访问</li>
</ol>
<blockquote>
<p>默认帐号guest只能用于本地访问，要远程访问可添加用户授权</p>
<p>添加新用户：rabbitmqctl add_user ming 123456</p>
<p>给新用户添加tags：rabbitmqctl set_user_tags ming administrator</p>
<p>授权：rabbitmqctl set_permissions ming “.*” “.*” “.*”</p>
<p>查看rabbitmqctl 命令的使用：rabbitmqctl </p>
</blockquote>
<ol start="6">
<li>重启</li>
</ol>
<blockquote>
<p>关闭：rabbitmqctl stop</p>
<p>启动：rabbitmqctl start_app</p>
<p>浏览器输入 ip:15672 进入登录界面，输入刚才创建的用户名和密码即可进入</p>
</blockquote>
<ol start="7">
<li>开放端口，15672是web管理界面的端口，5672是MQ访问的端口</li>
</ol>
<blockquote>
<p>如果是阿里云的服务器，需要到安全组中开放5672和15672端口</p>
</blockquote>
<h4 id="linux安装nacos"><a href="#linux安装nacos" class="headerlink" title="linux安装nacos"></a>linux安装nacos</h4><ol>
<li><p>确保先安装了JDK和Maven</p>
</li>
<li><p>上传tar.gz包到服务器，tar -zxvf xxx解压后，bin目录中运行</p>
<p>./startup.sh -m standalone</p>
</li>
</ol>
<h4 id="linux安装mysql"><a href="#linux安装mysql" class="headerlink" title="linux安装mysql"></a>linux安装mysql</h4><ol>
<li>检查是否已经安装过mysql</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">rpm</span> <span class="string">-qa</span> <span class="string">|</span> <span class="string">grep</span> <span class="string">mysql</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>如果已经安装，执行删除命令</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rpm -e --nodeps mysql-libs-5.1.73-5.el6_6.x86_64</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>查询所有mysql对应的文件夹,删除相关目录或文件</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">whereis</span> <span class="string">mysql</span></span><br><span class="line"><span class="string">rm</span> <span class="string">-rf</span> <span class="string">/usr/bin/mysql</span> <span class="string">/usr/include/mysql</span> <span class="string">/data/mysql</span> <span class="string">/data/mysql/mysql</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>检查mysql用户组和用户是否存在，如果没有，则创建</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/group | grep mysql</span><br><span class="line">cat /etc/passwd |grep mysql</span><br><span class="line">groupadd mysql</span><br><span class="line">useradd -r -g mysql mysql</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>下载mysql安装包</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://dev.mysql.com/get/Downloads/MySQL-5.7/mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>解压到/usr/local/mysql目录下</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tar xzvf mysql-5.7.24-linux-glibc2.12-x86_64.tar.gz</span><br></pre></td></tr></table></figure>

<ol start="7">
<li>在/usr/local/mysql目录下创建data目录</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir /usr/local/mysql/data</span><br></pre></td></tr></table></figure>

<ol start="8">
<li>更改mysql目录下所有的目录及文件夹所属的用户组和用户，以及权限</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">chown -R mysql:mysql /usr/local/mysql</span><br><span class="line">chmod -R 755 /usr/local/mysql</span><br></pre></td></tr></table></figure>

<ol start="9">
<li>编译安装并初始化mysql,<strong>务必记住初始化输出日志末尾的密码（数据库管理员临时密码）</strong></li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cd /usr/local/mysql/bin</span><br><span class="line">./mysqld --initialize --user=mysql --datadir=/usr/local/mysql/data --basedir=/usr/local/mysql</span><br></pre></td></tr></table></figure>

<ol start="10">
<li>编辑配置文件my.cnf</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">vi /etc/my.cnf</span><br><span class="line"></span><br><span class="line">[mysqld]</span><br><span class="line">datadir=/usr/local/mysql/data</span><br><span class="line">port=3306</span><br><span class="line">sql_mode=NO_ENGINE_SUBSTITUTION,STRICT_TRANS_TABLES</span><br><span class="line">symbolic-links=0</span><br><span class="line">max_connections=600</span><br><span class="line">innodb_file_per_table=1</span><br><span class="line">lower_case_table_names=1</span><br><span class="line">character_set_server=utf8</span><br></pre></td></tr></table></figure>

<ol start="11">
<li>测试启动mysql服务器</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/usr/local/mysql/support-files/mysql.server start</span><br></pre></td></tr></table></figure>

<ol start="12">
<li>添加软连接，并重启mysql服务</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/mysql/support-files/mysql.server /etc/init.d/mysql </span><br><span class="line">ln -s /usr/local/mysql/bin/mysql /usr/bin/mysql</span><br><span class="line">service mysql restart</span><br></pre></td></tr></table></figure>

<ol start="13">
<li>登录mysql，修改密码(密码为步骤5生成的临时密码)</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mysql -u root -p</span><br><span class="line">set password for root@localhost = password('yourpass');</span><br></pre></td></tr></table></figure>

<ol start="14">
<li>开放远程连接</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use mysql;</span><br><span class="line">update user set user.Host='%' where user.User='root';</span><br><span class="line">flush privileges;</span><br></pre></td></tr></table></figure>

<ol start="15">
<li>设置开机自动启动</li>
</ol>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">1、将服务文件拷贝到init.d下，并重命名为mysql</span><br><span class="line">[root@localhost /]# cp /usr/local/mysql/support-files/mysql.server /etc/init.d/mysqld</span><br><span class="line">2、赋予可执行权限</span><br><span class="line">[root@localhost /]# chmod +x /etc/init.d/mysqld</span><br><span class="line">3、添加服务</span><br><span class="line">[root@localhost /]# chkconfig --add mysqld</span><br><span class="line">4、显示服务列表</span><br><span class="line">[root@localhost /]# chkconfig --list</span><br></pre></td></tr></table></figure>

<h3 id="Eureka"><a href="#Eureka" class="headerlink" title="Eureka"></a>Eureka</h3><h4 id="单机版Eureka服务端"><a href="#单机版Eureka服务端" class="headerlink" title="单机版Eureka服务端"></a>单机版Eureka服务端</h4><ol>
<li>导入maven依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- eureka-server --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!--监控--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 一般通用配置 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-devtools<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>application.yml配置文件</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">localhost</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># false表示不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># false表示自己就是注册中心,我的职责是维护服务实例,并不需要去检索服务</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defalultZone:</span> <span class="string">http://$&#123;eureka.instance.hostname&#125;:$&#123;server.port&#125;/eureka/</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类标明是eureka服务端</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EurekaServerApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(EurekaServerApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>启动项目，访问服务器地址<a href="http://localhost:7001" target="_blank" rel="noopener">http://localhost:7001</a></li>
</ol>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211222400955.png" alt="image-eureka服务端启动"></p>
<h4 id="单机版Eureka客户端"><a href="#单机版Eureka客户端" class="headerlink" title="单机版Eureka客户端"></a>单机版Eureka客户端</h4><ol>
<li>导入Eureka client依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--eureka client--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-eureka-client<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--监控--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改application.yml配置文件，添加eureka client配置项</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 将自己注册进EurekaServer，默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer抓取已有的注册信息，默认为true</span></span><br><span class="line">    <span class="comment"># 单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># EurekaServer url</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://localhost:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在启动类上添加注解@EnableEurekaClient</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(PaymentApplication<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>先启动EurekaServer，再启动EurekaClient</li>
</ol>
<p><strong>必须先启动服务端，否则客户端连接会报错Connection refused: connect</strong></p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211230437404.png" alt="image-eurekaServer"></p>
<h4 id="单机版和集群版的比较"><a href="#单机版和集群版的比较" class="headerlink" title="单机版和集群版的比较"></a>单机版和集群版的比较</h4><p><strong>单机版本的Eureka会有单点故障的问题。</strong></p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201211234341772.png" alt="image-集群版Eureka"></p>
<p>多台EurekaServer服务器之间的关系是怎样的？<strong>互相注册，相互守望</strong></p>
<h4 id="集群版Eureka服务器"><a href="#集群版Eureka服务器" class="headerlink" title="集群版Eureka服务器"></a>集群版Eureka服务器</h4><p><strong>所谓的集群版是指：有多台EurekaServer服务器，它们互相 注册，相互守望 。</strong></p>
<p>创建的步骤和单机版的Eureka服务器很类似，由于它们要互相注册，相互守望，一个hostname满足不了。</p>
<p>所有，我们需要修改host文件将127.0.0.1本地映射成2个hostname。</p>
<ol>
<li>修改host文件，C:\Windows\System32\drivers\etc</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># mcloud</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> eureka7001.com</span><br><span class="line"><span class="number">127.0</span><span class="number">.0</span><span class="number">.1</span> eureka7002.com</span><br></pre></td></tr></table></figure>

<h5 id="修改hosts不生效解决方法"><a href="#修改hosts不生效解决方法" class="headerlink" title="修改hosts不生效解决方法"></a>修改hosts不生效解决方法</h5><ul>
<li><p>直接修改hosts文件，一般情况下是保存失败的。需要保存到其他目录，在复制进C:\Windows\System32\drivers\etc目录，选择继续替换掉原来的host</p>
</li>
<li><p>如果还不生效，尝试刷新一下DNS缓存。使用命令ipconfig /flushdns</p>
</li>
</ul>
<ol start="2">
<li><p>修改application.yml配置文件</p>
<p>7001端口的EurekaServer：</p>
</li>
</ol>
<p>注意hostname 和 service-url的配置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7001</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7001.com</span> <span class="comment">#eureka服务端的实例名称</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># false表示不向注册中心注册自己</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># false表示自己就是注册中心,我的职责是维护服务实例,并不需要去检索服务</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="comment"># 查询服务和注册服务都需要依赖这个地址</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>

<p>7002端口的EurekaServer：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">7002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">eureka7002.com</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka/</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动服务</li>
</ol>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212110342536.png" alt="image-port7001"></p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212110414933.png" alt="image-port7002"></p>
<h4 id="集群版Eureka客户端"><a href="#集群版Eureka客户端" class="headerlink" title="集群版Eureka客户端"></a>集群版Eureka客户端</h4><p>集群版的客户端主要是application.yml配置文件不同：<strong>service-url注册两个Eureka服务器的地址。</strong></p>
<p>order:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 将自己注册进EurekaServer，默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer抓取已有的注册信息，默认为true</span></span><br><span class="line">    <span class="comment"># 单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># EurekaServer url</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>

<p>payment:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 将自己注册进EurekaServer，默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer抓取已有的注册信息，默认为true</span></span><br><span class="line">    <span class="comment"># 单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># EurekaServer url</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>

<h4 id="集群版服务提供者"><a href="#集群版服务提供者" class="headerlink" title="集群版服务提供者"></a>集群版服务提供者</h4><p>由于有多台服务器提供服务，它们都要向注册中心注册服务。</p>
<p>只是application.yml的配置文件不同：比如server.port不同</p>
<p><strong>但是spring.application.name是相同的。集群版服务提供者暴露出一个相同的服务名称，但内部可能由多个端口提供服务。</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8002</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-payment-service</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="comment"># 当前数据库操作类型</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">com.alibaba.druid.pool.DruidDataSource</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/mcloud?useUnicode=true&amp;characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Asia/Shanghai</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="comment"># mapper.xml存放位置</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*.xml</span></span><br><span class="line">  <span class="comment"># 实体类不用写全限定类名</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.sise.cloud.model</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 将自己注册进EurekaServer，默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer抓取已有的注册信息，默认为true</span></span><br><span class="line">    <span class="comment"># 单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># EurekaServer url</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>

<p>那么，服务使用者order80该怎么去访问集群版的服务提供者提供的服务呢？</p>
<p><strong>只需要使用服务提供者暴露出来的服务名称。</strong></p>
<p>如下，统一使用CLOUD-PAYMENT-SERVICE访问8001和8002提供的服务。</p>
<p>经过测试，通过访问服务提供者application.yml中配置的小写的cloud-payment-service也是可以的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/customer"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> String ROOT = <span class="string">"http://CLOUD-PAYMENT-SERVICE"</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/create"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;String&gt; <span class="title">create</span><span class="params">(Payment payment)</span> </span>&#123;</span><br><span class="line">        CommonResult commonResult = restTemplate.postForEntity(ROOT + <span class="string">"/payment/create"</span>, payment, CommonResult<span class="class">.<span class="keyword">class</span>).<span class="title">getBody</span>()</span>;</span><br><span class="line">        <span class="keyword">return</span> commonResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/find/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">findById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id) </span>&#123;</span><br><span class="line">        CommonResult commonResult = restTemplate.getForEntity(ROOT + <span class="string">"/payment/find/"</span> + id, CommonResult<span class="class">.<span class="keyword">class</span>).<span class="title">getBody</span>()</span>;</span><br><span class="line">        <span class="keyword">return</span> commonResult;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时，如果使用order80去访问服务，会出现如下错误：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212131113323.png" alt="image-集群服务提供者访问出现错误"></p>
<p>这是由于有8001和8002多个服务提供者，而order80不知道应该去访问哪个服务。</p>
<p>因为order80是通过restTemplate去访问的服务，应该配置restTemplate的负载均衡。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BeanConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时再使用order80去访问，就可以访问到服务了。</p>
<p>使用默认的负载均衡策略- 轮询。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212131502623.png" alt="image-8001端口提供的服务"></p>
<p>刷新一下，可能看到的：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212131557705.png" alt="image-8002端口提供的服务"></p>
<h4 id="微服务主机信息和ip信息的配置"><a href="#微服务主机信息和ip信息的配置" class="headerlink" title="微服务主机信息和ip信息的配置"></a>微服务主机信息和ip信息的配置</h4><ol>
<li>配置前需要导入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改application.yml配置文件，设置instance-id 和 prefer-ip-address</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="comment"># 将自己注册进EurekaServer，默认为true</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 是否从EurekaServer抓取已有的注册信息，默认为true</span></span><br><span class="line">    <span class="comment"># 单节点无所谓，集群必须设置为true才能配合ribbon使用负载均衡</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># EurekaServer url</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 主机名称</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8002</span></span><br><span class="line">    <span class="comment"># 访问路径可以显示ip</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212134024996.png" alt="image-配置主机信息和ip信息"></p>
<h4 id="服务发现"><a href="#服务发现" class="headerlink" title="服务发现"></a>服务发现</h4><p>对于注册进Eureka的服务，可以通过服务发现获取服务的信息。</p>
<ol>
<li>注入org.springframework.cloud.client.discovery.DiscoveryClient类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Value</span>(<span class="string">"$&#123;spring.application.name&#125;"</span>)</span><br><span class="line"><span class="keyword">private</span> String applicationName;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"/discovery"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> Map&lt;String, Object&gt; <span class="title">discovery</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Map map = <span class="keyword">new</span> HashMap&lt;&gt;(<span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取EurekaServer上的所有服务名称</span></span><br><span class="line">    List&lt;String&gt; services = discoveryClient.getServices();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获取某个服务名称对应的所有实例信息</span></span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(applicationName);</span><br><span class="line"></span><br><span class="line">    map.put(<span class="string">"services"</span>,services);</span><br><span class="line">    map.put(<span class="string">"instances"</span>,instances);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> map;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>启动类上添加注解@EnableDiscoveryClient，==新版的springboot已经自动配置，可以不用加这个注解==</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Payment8001Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Payment8001Application<span class="class">.<span class="keyword">class</span>,<span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>输出结果：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212140312487.png" alt="image-服务发现获取服务信息"></p>
<h4 id="自我保护"><a href="#自我保护" class="headerlink" title="自我保护"></a>自我保护</h4><ol>
<li>为什么需要自我保护的机制？</li>
</ol>
<p>有时候，EurekaClient可以正常运行，但是与EurekaServer网络不通的情况，自我保护机制不会立刻将EurekaClient从服务注册表中删除。</p>
<ol start="2">
<li>什么是自我保护机制？</li>
</ol>
<p>EurekaServer将会尝试保护其服务注册表中的信息，不再删除服务注册表中的数据，也就是不会注销任何微服务。</p>
<p>当某时刻某一个微服务不可用了（在一定时间内（默认90s）没有接收到某个微服务实例的心跳），EurekaServer不会立即清理，依旧会对该微服务的信息进行保存。</p>
<ol start="3">
<li>如何关闭自我保护机制？</li>
</ol>
<p>EurekaServer的自我保护机制默认是开启的。可以在服务端的配置文件中设置：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">	<span class="attr">server:</span></span><br><span class="line">        <span class="comment"># 设置接收心跳的时间间隔</span></span><br><span class="line">        <span class="attr">eviction-interval-timer-in-ms:</span> <span class="number">2000</span></span><br><span class="line">        <span class="comment"># 关闭自我保护,默认值为true，保证不可用服务及时剔除	</span></span><br><span class="line">        <span class="attr">enable-self-preservation:</span> <span class="literal">false</span></span><br></pre></td></tr></table></figure>

<p>为了方便测试，设置EurekaClient发送心跳的时间间隔和服务器等待时间上限：</p>
<p>如下，每隔1s，客户端向服务器发送心跳。服务端在接收到最后一次心跳后，最长等待2s。</p>
<p>如果2s后没有再次接收到客户端的心跳信息，服务端又关闭了自我保护机制的话，客户端实例会被服务端从服务注册表中删除。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 主机名称</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">payment8001</span></span><br><span class="line">    <span class="comment"># 访问路径可以显示ip</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="comment"># 客户端向服务端发送心跳的时间间隔，默认为30s</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">1</span></span><br><span class="line">    <span class="comment"># 服务端在收到最后一次心跳后等待时间上限,默认为90s</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201212153620657.png" alt="image-自我保护机制"></p>
<h3 id="Ribbon"><a href="#Ribbon" class="headerlink" title="Ribbon"></a>Ribbon</h3><p>引入spring-cloud-starter-netflix-eureka-client的时候就自动引入了ribbon</p>
<h4 id="修改默认的负载均衡算法"><a href="#修改默认的负载均衡算法" class="headerlink" title="修改默认的负载均衡算法"></a>修改默认的负载均衡算法</h4><ol>
<li><p>实现自己的配置类，返回新的IRule实例。</p>
<p><strong>注意，配置类不能放在启动类能扫描到的包或子包下。</strong></p>
</li>
</ol>
<p><img src="C:%5CUsers%5Czjm16%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201213163211853.png" alt="image-配置类的存放路径"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerRuleConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IRule <span class="title">iRule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 修改为随机的负载均衡算法</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RandomRule();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在启动类上加上注解RibbonClient，指定配置类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@RibbonClient</span>(name = <span class="string">"cloud-payment-service"</span>,configuration = CustomerRuleConfiguration<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">OrderApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Ribbon负载均衡算法"><a href="#Ribbon负载均衡算法" class="headerlink" title="Ribbon负载均衡算法"></a>Ribbon负载均衡算法</h4><p><strong>rest接口第几次请求数 % 服务器集群总数量 = 实际调用服务位置下标</strong></p>
<p>每次服务重启后，rest接口计数从1开始。</p>
<p>使用自旋锁和CAS实现轮询算法：</p>
<ol>
<li>定义接口，定义方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">LoadBalance</span> </span>&#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 从多个服务实例中选择一个实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> instances 多个服务实例</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> ServiceInstance</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function">ServiceInstance <span class="title">instance</span><span class="params">(List&lt;ServiceInstance&gt; instances)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>实现LoadBanlance接口</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RoundLoadBalance</span> <span class="keyword">implements</span> <span class="title">LoadBalance</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> AtomicInteger atomicInteger = <span class="keyword">new</span> AtomicInteger(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ServiceInstance <span class="title">instance</span><span class="params">(List&lt;ServiceInstance&gt; instances)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> index = <span class="keyword">this</span>.getIndexAndIncrement(instances.size());</span><br><span class="line">        <span class="keyword">return</span> instances.get(index);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取当前服务的下标,并自增1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> size 服务的集群实例总数量</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 实际调用服务位置下标</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getIndexAndIncrement</span><span class="params">(<span class="keyword">int</span> size)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 自旋锁 和 CAS 实现轮询算法</span></span><br><span class="line">        <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">            <span class="keyword">int</span> current = atomicInteger.get();</span><br><span class="line">            <span class="keyword">int</span> next = (current + <span class="number">1</span>) % size;</span><br><span class="line">            <span class="comment">// 如果下标更新成功了,返回。更新不成功,自旋直至更新成功</span></span><br><span class="line">            <span class="keyword">if</span>(atomicInteger.compareAndSet(current, next)) &#123;</span><br><span class="line">                <span class="keyword">return</span> next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>注入LoadBalance，调用服务</li>
</ol>
<p>在调用自己实现的LoadBalance之前，记得去掉RestTemplate的@LocdBalance注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> LoadBalance loadBalance;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> DiscoveryClient discoveryClient;</span><br><span class="line"></span><br><span class="line"><span class="meta">@GetMapping</span>(<span class="string">"round/find/&#123;id&#125;"</span>)</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommonResult <span class="title">findByIdAndRound</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id) </span>&#123;</span><br><span class="line">    List&lt;ServiceInstance&gt; instances = discoveryClient.getInstances(<span class="string">"cloud-payment-service"</span>);</span><br><span class="line">    ServiceInstance instance = loadBalance.instance(instances);</span><br><span class="line">    URI uri = instance.getUri();</span><br><span class="line">    <span class="keyword">return</span> restTemplate.getForObject(uri +<span class="string">"/payment/find/"</span> + id, CommonResult<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="OpenFeign"><a href="#OpenFeign" class="headerlink" title="OpenFeign"></a>OpenFeign</h3><h4 id="基本使用"><a href="#基本使用" class="headerlink" title="基本使用"></a>基本使用</h4><p>OpenFeign集成了Ribbon和RestTemplate，提供了一种接口+@FeginClient进行服务调用的机制。</p>
<ol>
<li>引入maven依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-openfeign<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>application.yml配置文件</li>
</ol>
<p>此处不将其注册为EurekaService的服务，设置了register-with-eureka: false</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-openFeign-order-service</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">false</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka,http://eureka7002.com:7002/eureka</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>编写启动类，加上@EnableFeignClients</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderOpenFeignApplication</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(OrderOpenFeignApplication<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写接口，加上@FeignClient</li>
</ol>
<p>@FeignClient的name属性是服务提供者的服务名称。</p>
<p>接口中的方法与服务提供者Controller的方法相同，url也应该相同。</p>
<p>服务消费者的PaymentService:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"cloud-payment-service"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/payment/create"</span>)</span><br><span class="line">    <span class="function">CommonResult&lt;Long&gt; <span class="title">create</span><span class="params">(@RequestBody Payment payment)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/payment/find/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">CommonResult&lt;Payment&gt; <span class="title">findById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>服务提供者的PaymentController:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/payment"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;server.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String port;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping</span>(<span class="string">"/create"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Long&gt; <span class="title">create</span><span class="params">(@RequestBody  Payment payment)</span></span>&#123;</span><br><span class="line">        Integer row = paymentService.create(payment);</span><br><span class="line">        <span class="keyword">return</span> row != <span class="keyword">null</span> ? <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">200</span>,<span class="string">"ok"</span> + port, payment.getId())</span><br><span class="line">                : <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">500</span>,<span class="string">"create error"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/find/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">findById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id) </span>&#123;</span><br><span class="line">        Payment payment = paymentService.findById(id);</span><br><span class="line">        <span class="keyword">return</span> payment != <span class="keyword">null</span> ? <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">200</span>,<span class="string">"ok"</span> + port,payment)</span><br><span class="line">                : <span class="keyword">new</span> CommonResult&lt;&gt;(<span class="number">404</span>,<span class="string">"not found"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写服务消费者的controller，直接调用PaymentService,不需要使用Ribbon</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/customer"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/create"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Long&gt; <span class="title">create</span><span class="params">(Payment payment)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentService.create(payment);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/find/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> CommonResult&lt;Payment&gt; <span class="title">findById</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> Long id) </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> paymentService.findById(id);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="超时机制"><a href="#超时机制" class="headerlink" title="超时机制"></a>超时机制</h4><p>OpenFeign的默认超时时间是1s，请求超出这个时间，会报timeout的错误。</p>
<p>设置超时时间：</p>
<p>由于OpenFeign底层是ribbon，设置的是ribbon的属性。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">ribbon:</span></span><br><span class="line">  <span class="attr">ReadTimeout:</span> <span class="number">5000</span></span><br><span class="line">  <span class="attr">ConnectTimeout:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>

<h4 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h4><p>OpenFeign提供了日志对接口的调用情况进行监控和输出。</p>
<p>日志级别：</p>
<ul>
<li>NONE：默认的，不显示任何日志</li>
<li>BASIC：仅记录请求方法、URL、响应状态码以及执行时间</li>
<li>HEADERS：除了BASIC定义的信息之外，还有请求和响应的头信息</li>
<li>FULL：除了HEADERS中定义的信息之外，还有请求和响应的正文以及元数据</li>
</ul>
<ol>
<li>添加配置类，设置日志级别</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FeginConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="keyword">public</span> Logger.<span class="function">Level <span class="title">logLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> Logger.Level.FULL;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>application.yml配置文件</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">logging:</span></span><br><span class="line">  <span class="attr">level:</span></span><br><span class="line">    <span class="comment"># 设置类的日志级别</span></span><br><span class="line">    <span class="attr">com.sise.cloud.service.PaymentService:</span>  <span class="string">debug</span></span><br></pre></td></tr></table></figure>

<h3 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h3><h4 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h4><blockquote>
<p>服务降级（fallback）</p>
</blockquote>
<p>哪些情况会发生服务降级：</p>
<ul>
<li>异常</li>
<li>超时</li>
<li>服务熔断</li>
<li>线程池/信号量打满</li>
</ul>
<blockquote>
<p>服务熔断（break）</p>
</blockquote>
<p>类比保险丝达到最大服务访问后，直接拒绝访问，拉闸限电，然后调用服务降级</p>
<blockquote>
<p>服务限流（flow limit）</p>
</blockquote>
<p>秒杀高并发等操作，一秒钟N个，有序进行。</p>
<p>服务降级 -&gt; 进而熔断 -&gt; 限流</p>
<h4 id="服务降级"><a href="#服务降级" class="headerlink" title="服务降级"></a>服务降级</h4><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-netflix-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>@HystrixCommand注解的使用</li>
</ol>
<p>@HystrixCommand指定当发生超时或异常时，执行fallbackMethod指定的降级方法。</p>
<p>@HystrixProperty指定超时上限，当超过这个时间时，会执行fallbackMethod指定的降级方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"timeoutOrExceptionHandler"</span>,commandProperties = &#123;</span><br><span class="line">           <span class="meta">@HystrixProperty</span>(name=<span class="string">"execution.isolation.thread.timeoutInMilliseconds"</span>,value = <span class="string">"1000"</span>)</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">timeout</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           TimeUnit.SECONDS.sleep(<span class="number">3</span>);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">           e.printStackTrace();</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"线程池："</span> + Thread.currentThread().getName() + <span class="string">"hystrix,timeout,id:"</span> + id + <span class="string">"耗时:3s"</span>;</span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">timeoutOrExceptionHandler</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"发生超时，或者发生异常. id:"</span> + id;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类开启Hystrix</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableHystrix</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HystrixPayment8001Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(HystrixPayment8001Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>细节：</p>
<ol>
<li>fallbackMethod指定的方法可以放在controller层，但是指定的方法和@HystrixCommand必须在同一个文件，否则报错fallback method wasn’t found</li>
<li>若发生异常，异常并不会抛出，直接执行了fallbackMethod指定的方法</li>
<li>服务降级可以添加在服务器，也可以添加在客户端</li>
<li>若客户端和服务端都做了服务降级，优先执行客户端的降级方法</li>
<li>fallbackMethod方法的参数要和对应的服务的方法形参类型一致</li>
</ol>
<h4 id="全局服务降级"><a href="#全局服务降级" class="headerlink" title="全局服务降级"></a>全局服务降级</h4><p>为每一个方法写一个fallbackMethod真的是太麻烦了。我们希望有一个全局的方法，当我方法上没指定fallbackMethod的时候，使用全局的fallbackMethod方法，当方法上指定了fallbackMethod的时候，使用方法上指定的fallbackMethod方法。</p>
<ol>
<li>使用@DefaultProperties在类上标记fallbackMethod</li>
<li>使用@HystrixCommand在方法上标记，当方法出现异常或超时，又没有指定fallbackMethod时，使用@DefaultProperties标记的fallbackMethod方法</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/customer"</span>)</span><br><span class="line"><span class="meta">@DefaultProperties</span>(defaultFallback = <span class="string">"timeoutOrExceptionHandler"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/ok/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function">String <span class="title">ok</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> a = <span class="number">10</span> / <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">return</span> paymentService.ok(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//@HystrixCommand(fallbackMethod = "timeoutOrExceptionHandler",commandProperties = &#123;</span></span><br><span class="line">    <span class="comment">//        @HystrixProperty(name = "execution.isolation.thread.timeoutInMilliseconds",value = "6000")</span></span><br><span class="line">    <span class="comment">//&#125;)</span></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/timeout/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="meta">@HystrixCommand</span></span><br><span class="line">    <span class="function">String <span class="title">timeout</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentService.timeout(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">timeoutOrExceptionHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"80发生超时，或者发生异常."</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>全局服务降级可以为同一个类中的方法统一一个fallbackMethod，但是与类形成了耦合，无法在多个类中共用。</p>
<h4 id="Feign支持的松耦合服务降级"><a href="#Feign支持的松耦合服务降级" class="headerlink" title="Feign支持的松耦合服务降级"></a>Feign支持的松耦合服务降级</h4><p>当使用Fegin的时候，调用的方法都是来自一个标记了@FeignClient的接口，我们就可以利用这个接口结合Feign，对接口中的每一个方法实现一个fallbackMethod方法。</p>
<ol>
<li>编写一个类实现提供服务的接口，并加入到容器当中</li>
</ol>
<p>当在服务接口指定了fallbackMethod对应的类，而这个类没有加入到容器中时，启动的时候扫描不到，会报错</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentFallbackMethod</span> <span class="keyword">implements</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">ok</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"paymentService ok method is exception or timeout"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">timeout</span><span class="params">(String id)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"paymentService timeout method is exception or timeout"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>在服务提供接口指定fallbackMethod</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient</span>(name = <span class="string">"cloud-hystrix-payment-service"</span>,fallback = PaymentFallbackMethod<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">interface</span> <span class="title">PaymentService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/payment/ok/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">String <span class="title">ok</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id)</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/payment/timeout/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function">String <span class="title">timeout</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id)</span>;</span><br><span class="line">    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>application.yml开启Feign对Hystrix的支持</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">feign:</span></span><br><span class="line">  <span class="attr">hystrix:</span></span><br><span class="line">    <span class="attr">enabled:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="服务熔断"><a href="#服务熔断" class="headerlink" title="服务熔断"></a>服务熔断</h4><p>熔断机制是应对雪崩效应的一种微服务链路保护机制。当某个微服务出错不可用或者响应时间太长时，会进行服务的降级，进而熔断该节点微服务的调用，快速返回错误的响应信息。<strong>当检测到该节点微服务调用响应正常后，恢复调用链路。</strong></p>
<p>在SpringCloud框架里，熔断机制通过Hystrix实现，Hystrix会监控微服务间调用的状况，当失败的调用到一定阈值，默认是5s内20次调用失败，就会启动熔断机制。</p>
<p>熔断机制的注解是@HystrixCommand.</p>
<p>下列代码表明：在10s内服务调用超过了10次，且失败了6次（60%），会启动熔断机制</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"timeoutOrExceptionHandler"</span>,commandProperties = &#123;</span><br><span class="line">           <span class="comment">// 开启服务熔断</span></span><br><span class="line">           <span class="meta">@HystrixProperty</span>(name=<span class="string">"circuitBreaker.enabled"</span>,value = <span class="string">"true"</span>),</span><br><span class="line">           <span class="comment">// 请求次数，次数超过阈值后，才会开启断路器</span></span><br><span class="line">           <span class="meta">@HystrixProperty</span>(name=<span class="string">"circuitBreaker.requestVolumeThreshold"</span>,value = <span class="string">"10"</span>),</span><br><span class="line">           <span class="comment">// 时间范围</span></span><br><span class="line">           <span class="meta">@HystrixProperty</span>(name=<span class="string">"circuitBreaker.sleepWindowInMilliseconds"</span>,value = <span class="string">"10000"</span>),</span><br><span class="line">           <span class="comment">// 失败率达到多少后跳闸</span></span><br><span class="line">           <span class="meta">@HystrixProperty</span>(name=<span class="string">"circuitBreaker.errorThresholdPercentage"</span>,value = <span class="string">"60"</span>),</span><br><span class="line">   &#125;)</span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">test</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span>(id &lt; <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"id 不能为负数"</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"ok,id:"</span> + UUID.randomUUID();</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> String <span class="title">timeoutOrExceptionHandler</span><span class="params">(<span class="keyword">int</span> id)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="string">"8001发生超时，或者发生异常. id:"</span> + id ;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>三个重要参数：</p>
<ul>
<li>快照时间戳：断路器统计一些请求和错误信息的统计时间范围，默认为最近的10秒</li>
<li>请求总数阈值：在快照时间窗内，必须满足请求总数阈值才有资格熔断。默认值是20，意味着在10秒内，如果调用次数不足20次，即使所有的请求都超时或其他原因失败，断路器都不会打开</li>
<li>错误百分比阈值：当请求总数在快照时间窗内超过了阈值，比如，发生了30次调用，而有15次调用失败，也就是50%的错误百分比，这时候断路器就会打开。默认值是50%</li>
</ul>
<p><strong>断路器开启/关闭的条件：</strong></p>
<ul>
<li>当满足一定请求阈值的时候（默认10秒内超过20个请求）</li>
<li>并且失败率达到阈值的时候（默认10秒内超过50%的请求失败）</li>
<li>到达以上阈值，断路器将会开启，所有的请求都不会进行转发</li>
<li>一段时间之后（默认是5秒），这个时间断路器是半开状态，会让其中一个请求进行转发，如果成功，断路器会关闭，若失败，继续开启，重复以上步骤</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">断路器的打开和关闭,是按照一下<span class="number">5</span>步决定的</span><br><span class="line">  	<span class="number">1</span>,并发此时是否达到我们指定的阈值</span><br><span class="line">  	<span class="number">2</span>,错误百分比,比如我们配置了<span class="number">60</span>%,那么如果并发请求中,<span class="number">10</span>次有<span class="number">6</span>次是失败的,就开启断路器</span><br><span class="line">  	<span class="number">3</span>,上面的条件符合,断路器改变状态为open(开启)</span><br><span class="line">  	<span class="number">4</span>,这个服务的断路器开启,所有请求无法访问</span><br><span class="line">  	<span class="number">5</span>,在我们的时间窗口期,期间,尝试让一些请求通过(半开状态),如果请求还是失败,证明断路器还是开启状态,服务没有恢复</span><br><span class="line">  		如果请求成功了,证明服务已经恢复,断路器状态变为close关闭状态</span><br></pre></td></tr></table></figure>

<h3 id="Gateway"><a href="#Gateway" class="headerlink" title="Gateway"></a>Gateway</h3><h4 id="服务搭建"><a href="#服务搭建" class="headerlink" title="服务搭建"></a>服务搭建</h4><ol>
<li>引入依赖，注意gateway不需要引入web和actuator</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-gateway<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>application.yml配置路由</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_rout</span></span><br><span class="line">          <span class="comment"># 真实的访问url</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span></span><br><span class="line">          <span class="comment"># **表示匹配参数</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/find/**</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_route</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">http://localhost:8001</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/create/**</span></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Gateway9527Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Gateway9527Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost:9527/payment/find/1</span></span><br><span class="line">http:<span class="comment">//localhost:8001/payment/find/1</span></span><br><span class="line">访问的是相同的页面，隐藏了<span class="number">8001</span>端口，对外暴露出<span class="number">9527</span>的端口</span><br></pre></td></tr></table></figure>

<h4 id="编码方式配置路由"><a href="#编码方式配置路由" class="headerlink" title="编码方式配置路由"></a>编码方式配置路由</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GatewayConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入RouteLocatorBuilder构建RouteLocator</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> builder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RouteLocator <span class="title">customerRouter</span><span class="params">(RouteLocatorBuilder builder)</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">"fuck"</span>);</span><br><span class="line">        RouteLocatorBuilder.Builder routes = builder.routes();</span><br><span class="line">        <span class="comment">// 构建一个/blog 指向 http://www.caixukun8.top</span></span><br><span class="line">        routes.route(<span class="string">"blog_route"</span>, r -&gt; r.path(<span class="string">"/fuck"</span>).uri(<span class="string">"http://news.baidu.com/guonei"</span>));</span><br><span class="line">        <span class="keyword">return</span> routes.build();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="通过微服务名实现动态路由"><a href="#通过微服务名实现动态路由" class="headerlink" title="通过微服务名实现动态路由"></a>通过微服务名实现动态路由</h4><p>上面的uri配置是写死在application.yml文件中的，我们可以利用gateway的动态路由，通过微服务的名称，负载均衡的查找服务。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9527</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-gateway-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="comment"># 开启从注册中心动态创建路由的功能，利用微服务名称进行路由</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">locator:</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_rout</span></span><br><span class="line">          <span class="comment"># 真实的访问url</span></span><br><span class="line">          <span class="comment">#uri: http://localhost:8001</span></span><br><span class="line">          <span class="comment"># lb是写死的,loadBalance,表示负载均衡</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">          <span class="comment"># **表示匹配参数</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/find/**</span></span><br><span class="line"></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">payment_route</span></span><br><span class="line">          <span class="comment">#uri: http://localhost:8001</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://cloud-payment-service</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/payment/create/**</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">register-with-eureka:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">fetch-registry:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<p>当访问<a href="http://localhost:9527/payment/find/1的时候，通过负载均衡去查找8001或8002端口提供的服务。" target="_blank" rel="noopener">http://localhost:9527/payment/find/1的时候，通过负载均衡去查找8001或8002端口提供的服务。</a></p>
<h3 id="Config"><a href="#Config" class="headerlink" title="Config"></a>Config</h3><hr>
<h4 id="读取远程仓库的配置文件"><a href="#读取远程仓库的配置文件" class="headerlink" title="读取远程仓库的配置文件"></a>读取远程仓库的配置文件</h4><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-config-server<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>application.yml配置文件</li>
</ol>
<ul>
<li>配置中心无需配置name属性和profile属性，只有别的服务来访问配置中心时，别的服务才需要配置name属性和profile属性</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="comment"># 文件名-前面的</span></span><br><span class="line">      <span class="comment"># name: config</span></span><br><span class="line">      <span class="comment"># 文件名-后面的</span></span><br><span class="line">      <span class="comment"># profile: dev</span></span><br><span class="line">      <span class="comment"># 远程仓库地址</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">git@github.com:JinMing8/mcloud.git</span></span><br><span class="line">          <span class="comment"># 配置文件在远程仓库的存放目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">mcloud</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config3344Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Config3344Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<p>假设github上存在以下两个配置文件：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201219142706651.png" alt="image-20201219142706651"></p>
<p>通过浏览器访问：<a href>http://localhost:3344/master/config-prod.yml</a>得到以下结果：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">  <span class="attr">info:</span> <span class="string">mater</span> <span class="string">branch,config-prod,version</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p>或者通过<a href>http://localhost:3344/config-prod/master</a> 得到JSON格式的返回结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"config-prod"</span>,</span><br><span class="line">  <span class="attr">"profiles"</span>: [</span><br><span class="line">    <span class="string">"master"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"label"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"6abe5f2cbb64765bc7ffa0ca3a8574f8b57256f8"</span>,</span><br><span class="line">  <span class="attr">"state"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"propertySources"</span>: [</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="attr">"name"</span>: <span class="string">"git@github.com:JinMing8/mcloud.git/config-prod.yml"</span>,</span><br><span class="line">      <span class="attr">"source"</span>: &#123;</span><br><span class="line">        <span class="attr">"config.info"</span>: <span class="string">"mater branch,config-prod,version 1"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果访问的路径在远程仓库中不存在，会返回以下的结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"name"</span>: <span class="string">"config-prod.yml"</span>,</span><br><span class="line">  <span class="attr">"profiles"</span>: [</span><br><span class="line">    <span class="string">"master"</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">"label"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"version"</span>: <span class="string">"6abe5f2cbb64765bc7ffa0ca3a8574f8b57256f8"</span>,</span><br><span class="line">  <span class="attr">"state"</span>: <span class="literal">null</span>,</span><br><span class="line">  <span class="attr">"propertySources"</span>: [</span><br><span class="line">    </span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果访问的文件在远程仓库中不存在，会返回以下的结果：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="配置中心的搭建"><a href="#配置中心的搭建" class="headerlink" title="配置中心的搭建"></a>配置中心的搭建</h4><p>以上只是单独创建了一个服务，去访问远程仓库的配置文件。</p>
<p>如果想让它成为配置中心，也非常简单，将其注册成为EurekaSerrver的一个服务即可。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<p>启动类上加入注解：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="meta">@EnableConfigServer</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config3344Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Config3344Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="其他服务访问配置中心"><a href="#其他服务访问配置中心" class="headerlink" title="其他服务访问配置中心"></a>其他服务访问配置中心</h4><p>其他服务不直接访问访问远程仓库获取配置信息，而是访问配置中心获取配置文件的信息。</p>
<ol>
<li>引入依赖，config的客户端</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>bootstarp.yml的配置文件</li>
</ol>
<ul>
<li>config的客户端使用的配置文件是bootstrap.yml，而不是application.yml</li>
</ul>
<blockquote>
<p>application.yml 和 bootstrap.yml文件的区别：</p>
<table>
<thead>
<tr>
<th align="center">application.yml</th>
<th>bootstrap.yml</th>
</tr>
</thead>
<tbody><tr>
<td align="center">用户级别的资源配置项</td>
<td>系统级别，优先级更加高</td>
</tr>
<tr>
<td align="center">上下文是ApplicationContext</td>
<td>上下文是BootstrapContext,是ApplicationContext的父上下文。BootstrapContext负责从外部源加载配置属性并解析配置，这两个上下文共享一个从外部获取的Environment</td>
</tr>
</tbody></table>
<ul>
<li>Bootstrap有高优先级，默认情况下，它们不会被本地配置覆盖。</li>
<li>Bootstrap和Application有不同的上下文，保证配置的分离</li>
</ul>
</blockquote>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-clinet-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="comment"># 配置文件-前面的</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="comment"># 配置文件-后面的</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">dev</span></span><br><span class="line">      <span class="comment"># 读取配置文件的地址</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Config3355Application</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Config3355Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>编写测试Controller</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line">	<span class="comment">// 直接读取配置文件的信息</span></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;config.info&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/configInfo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">configInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的controller中直接从配置文件中读取配置信息，如果配置中心中不存在对应的配置中心，@Value读取失败，启动的时候就报错了。</p>
<ol start="5">
<li>测试</li>
</ol>
<p>访问<a href>http://localhost:3355/configInfo</a>，返回以下结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mater branch,config-prod,version 1</span><br></pre></td></tr></table></figure>

<p>如果访问<a href>http://localhost:3355/master/config-prod.yml</a>,会报404</p>
<p>此时，我们修改远程仓库的配置文件，将version 1 改成 version 2:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">    <span class="attr">info:</span> <span class="string">mater</span> <span class="string">branch,config-prod,version</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>再次访问<a href>http://localhost:3355/configInfo</a>，结果并没有刷新：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mater branch,config-prod,version 1</span><br></pre></td></tr></table></figure>

<p>如果访问[<a href="http://localhost:3344/master/config-prod.yml]，返回结果是修改后的配置文件：" target="_blank" rel="noopener">http://localhost:3344/master/config-prod.yml]，返回结果是修改后的配置文件：</a></p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">config:</span><br><span class="line">  info: mater branch,config-prod,version 2</span><br></pre></td></tr></table></figure>

<p><strong>也就是说，修改了远程仓库的配置文件，配置中心会立即刷新，而其他服务去访问配置中心，却不会刷新。</strong></p>
<h4 id="手动刷新其他服务的配置"><a href="#手动刷新其他服务的配置" class="headerlink" title="手动刷新其他服务的配置"></a>手动刷新其他服务的配置</h4><ol>
<li>引入actuator监控依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件中暴露监控端口</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 暴露监控端口</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在需要刷新配置信息的类上添加注解@RefreshScope</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;config.info&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/configInfo"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">configInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>利用actuator监控的特点，发生POST请求刷新服务</li>
</ol>
<p>利用curl命令，发生POST请求到[<a href="http://localhost:3355/actuator/refresh].刷新3355这个端口的配置信息" target="_blank" rel="noopener">http://localhost:3355/actuator/refresh].刷新3355这个端口的配置信息</a></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:3355/actuator/refresh</span><br></pre></td></tr></table></figure>

<p>通过@RefreshScope和发生post请求去刷新，这种方式虽然可以刷新配置信息。但是这种方式不是最好的，如果有100个服务，需要手动发送100次POST请求(或许你可以使用脚本)。</p>
<p>由于100个服务都是从配置中心读取的配置文件，那么我们可不可以只刷新配置中心，让配置中心去刷新其他服务的配置信息呢？这就需要利用Spring Cloud Bus 。</p>
<h3 id="Spring-Cloud-Bus"><a href="#Spring-Cloud-Bus" class="headerlink" title="Spring Cloud Bus"></a>Spring Cloud Bus</h3><p>Spring Cloud Bus是用来将分布式系统的节点与轻量级消息系统链接起来的框架，它整合了Java的事件处理机制和消息中间件的功能。</p>
<p>Spring Cloud Bus目前支持RabbitMQ和Kafka。</p>
<h4 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h4><p>每个ConfigClient实例都监听MQ中同一个topic（默认是SpringCloudBus）,当一个服务刷新数据的时候，它会把这个信息放入到topic中，这样其他监听同一topic的服务就能得到通知，然后去更新自身的配置信息。</p>
<p>那么，我们就有2种方案来实现配置信息的刷新：</p>
<ul>
<li>通知ConfigClient中的其中一个客户端，这个客户端刷新数据的时候，会把更新的信息放入到topic中，其他客户端得到通知而更新自身配置</li>
<li>通知配置中心，由配置中心广播给其他客户端</li>
</ul>
<p>我们采用通知配置中心的方案来更新配置信息，第一种方案有如下缺点：</p>
<ul>
<li>打破了微服务的职责单一性，因为微服务本身是业务模块，它本不应该承担配置刷新的职责</li>
<li>破坏了微服务各个节点的对等性</li>
</ul>
<h4 id="通知配置中心，实现配置的自动刷新"><a href="#通知配置中心，实现配置的自动刷新" class="headerlink" title="通知配置中心，实现配置的自动刷新"></a>通知配置中心，实现配置的自动刷新</h4><ol>
<li>配置中心引入actuator,rabbitmq依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 添加消息总线RabbitMQ支持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-bus-amqp<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--监控--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件中设置rabbitMQ设置,暴露监听端口</li>
</ol>
<p>配置中心完整的配置文件如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3344</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="comment"># 远程仓库地址</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">git:</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">git@github.com:JinMing8/mcloud.git</span></span><br><span class="line">          <span class="comment"># 配置文件在远程仓库的存放目录</span></span><br><span class="line">          <span class="attr">search-paths:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">mcloud</span></span><br><span class="line">  <span class="comment"># rabbitmq配置</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">ming</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br><span class="line"><span class="comment"># 暴露监听端口</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"bus-refresh"</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>ConfigClient也需要引入rabbitMQ依赖，并在配置文件中引入rabbitMQ的支持</li>
</ol>
<p>ConfigClient完整的配置文件如下：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3355</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-config-clinet-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 分支</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="comment"># 配置文件-前面的</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">      <span class="comment"># 配置文件-后面的</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">prod</span></span><br><span class="line">      <span class="comment"># 读取配置文件的地址</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">http://localhost:3344</span></span><br><span class="line">  <span class="comment">#rabbitMQ配置</span></span><br><span class="line">  <span class="attr">rabbitmq:</span></span><br><span class="line">    <span class="attr">host:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span></span><br><span class="line">    <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">ming</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<p>在远程仓库中修改配置文件信息后，发送POST请求通知配置中心，其他ConfigClient会收到配置中心的通知，从而更新自身的配置信息。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:3344/actuator/bus-refresh</span><br></pre></td></tr></table></figure>

<h4 id="定点通知"><a href="#定点通知" class="headerlink" title="定点通知"></a>定点通知</h4><p>所谓定点通知，即通知部分ConfigClient，而不是全部的ConfigClient。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http:<span class="comment">//localhost:$&#123;serverport&#125;/actuator/bus-refresh/$&#123;destnation&#125;</span></span><br></pre></td></tr></table></figure>

<p>/bus/refresh请求不再发送到具体的服务实例上，而是发给配置中心，并通过destnation参数指定需要更新配置的服务实例。</p>
<p>这里的destnation实际上是服务名称（spring.application.name指定）+端口号。</p>
<p>比如上面的栗子，只通知localhost:3355这个服务实例更新配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -X POST http://localhost:3344/actuator/bus-refresh/cloud-config-clinet-service:3355</span><br></pre></td></tr></table></figure>

<h3 id="Spring-Cloud-Stream"><a href="#Spring-Cloud-Stream" class="headerlink" title="Spring Cloud Stream"></a>Spring Cloud Stream</h3><h4 id="通信模型"><a href="#通信模型" class="headerlink" title="通信模型"></a>通信模型</h4><p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201219235538034.png" alt="image-Stream通信模型"></p>
<blockquote>
<p>Source和Sink</p>
</blockquote>
<ul>
<li>发送消息端（生产者）是Source</li>
<li>消息接收端（消费者）是Sink</li>
</ul>
<blockquote>
<p>Channel</p>
</blockquote>
<p>队列的一种抽象，在消息通讯系统中就是实现存储和转发的媒介。</p>
<h4 id="构建生产者"><a href="#构建生产者" class="headerlink" title="构建生产者"></a>构建生产者</h4><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件</li>
</ol>
<p>生产者的配置文件：与stream整合需要一个binder，而binder指定消息服务的具体环境（比如使用rabbitMQ的host，username等）</p>
<p><strong>rabbitmq的配置是写在spring内的。</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8801</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-provide-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span></span><br><span class="line">        <span class="comment"># 自定义一个binder的名称，用于stream的整合配置</span></span><br><span class="line">        <span class="attr">default-rabbit:</span></span><br><span class="line">          <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span></span><br><span class="line">          <span class="comment"># rabbitMQ相关的环境配置</span></span><br><span class="line">          <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">                <span class="attr">host:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">ming</span></span><br><span class="line">                <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="comment"># stream的整合配置</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">        <span class="attr">output:</span></span><br><span class="line">          <span class="comment"># 生产者生产的消息放到哪个通道</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span></span><br><span class="line">          <span class="comment"># 消息类型，本次为json，如果是文本则设置为text/plain</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">text/plain</span></span><br><span class="line">          <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">default-rabbit</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 主机名称</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">send-8801</span></span><br><span class="line">    <span class="comment"># 显示ip</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamProvide8801Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StreamProvide8801Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>Source类生产消息</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@Author</span> Ming</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@Date</span> 2020/12/20 00:20</span></span><br><span class="line"><span class="comment"> *<span class="doctag">@Description</span> 消息生产者</span></span><br><span class="line"><span class="comment"> * 1. Source 是org.springframework.cloud.stream.messaging.Source包的</span></span><br><span class="line"><span class="comment"> * 2. 不需要使用<span class="doctag">@Service</span>将其加入到容器，<span class="doctag">@EnableBinding</span>已经指定这是一个Binder,</span></span><br><span class="line"><span class="comment"> *      将Channel和exchange绑定在一起</span></span><br><span class="line"><span class="comment"> * 3. 注意不要引错包</span></span><br><span class="line"><span class="comment"> * import org.springframework.messaging.Message;</span></span><br><span class="line"><span class="comment"> * import org.springframework.messaging.MessageChannel;</span></span><br><span class="line"><span class="comment"> * import org.springframework.messaging.support.MessageBuilder;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">@EnableBinding</span>(Source<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">MessageProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 注入消息管道,messageChannel接口有多个实现类，我们需要使用的是Source类,</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="meta">@Qualifier</span>(<span class="string">"output"</span>)</span><br><span class="line">    <span class="keyword">private</span> MessageChannel output;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">send</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 构建Message,消息内容为UUID</span></span><br><span class="line">        Message&lt;String&gt; message = MessageBuilder.withPayload(UUID.randomUUID().toString()).build();</span><br><span class="line">        <span class="comment">// 输出消息内容</span></span><br><span class="line">        System.out.println(message.getPayload());</span><br><span class="line">        <span class="comment">// 将消息发送至Channel</span></span><br><span class="line">        output.send(message);</span><br><span class="line">        <span class="keyword">return</span> message.getPayload();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">MessageChannel有多个实现类，这里的output与配置文件中配置的需要一致。</span><br></pre></td></tr></table></figure>

<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220003426084.png" alt="image-MessageChannel的注入"></p>
<ol start="5">
<li>测试</li>
</ol>
<p>登录rabbitMQ的管理界面，可以看到我们自定义的studyExchange:</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220153356198.png" alt="image-studyExchange"></p>
<h4 id="构建消费者"><a href="#构建消费者" class="headerlink" title="构建消费者"></a>构建消费者</h4><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-stream-rabbit<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件</li>
</ol>
<p>消费者主要是配置rabbitMQ的相关配置，并且配置从哪个Channel取出消息</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8802</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-stream-customer-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">stream:</span></span><br><span class="line">      <span class="attr">binders:</span></span><br><span class="line">        <span class="comment"># 自定义一个binder的名称，用于stream的整合配置</span></span><br><span class="line">        <span class="attr">default-rabbit:</span></span><br><span class="line">          <span class="comment"># 消息组件类型</span></span><br><span class="line">          <span class="attr">type:</span> <span class="string">rabbit</span></span><br><span class="line">          <span class="comment"># rabbitMQ相关的环境配置</span></span><br><span class="line">          <span class="attr">environment:</span></span><br><span class="line">            <span class="attr">spring:</span></span><br><span class="line">              <span class="attr">rabbitmq:</span></span><br><span class="line">                <span class="attr">virtual-host:</span> <span class="string">/</span></span><br><span class="line">                <span class="attr">host:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span></span><br><span class="line">                <span class="attr">port:</span> <span class="number">5672</span></span><br><span class="line">                <span class="attr">username:</span> <span class="string">ming</span></span><br><span class="line">                <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">      <span class="comment"># stream的整合配置</span></span><br><span class="line">      <span class="attr">bindings:</span></span><br><span class="line">        <span class="attr">input:</span></span><br><span class="line">          <span class="comment"># 消费者消费的消息从哪个通道取</span></span><br><span class="line">          <span class="attr">destination:</span> <span class="string">studyExchange</span></span><br><span class="line">          <span class="comment"># 消息类型，本次为json，如果是文本则设置为text/plain</span></span><br><span class="line">          <span class="attr">content-type:</span> <span class="string">text/plain</span></span><br><span class="line">          <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line">          <span class="attr">binder:</span> <span class="string">default-rabbit</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">eureka:</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">service-url:</span></span><br><span class="line">      <span class="attr">defaultZone:</span> <span class="string">http://eureka7001.com:7001/eureka</span></span><br><span class="line">  <span class="attr">instance:</span></span><br><span class="line">    <span class="comment"># 主机名称</span></span><br><span class="line">    <span class="attr">instance-id:</span> <span class="string">customer-8802</span></span><br><span class="line">    <span class="comment"># 显示ip</span></span><br><span class="line">    <span class="attr">prefer-ip-address:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">lease-renewal-interval-in-seconds:</span> <span class="number">2</span></span><br><span class="line">    <span class="attr">lease-expiration-duration-in-seconds:</span> <span class="number">5</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableEurekaClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StreamCustomer8802Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(StreamCustomer8802Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>业务类取出消息</li>
</ol>
<p>方法上使用注解@StreamListener，方法形参绑定发送者发送的消息类型。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@EnableBinding</span>(Sink<span class="class">.<span class="keyword">class</span>)</span></span><br><span class="line"><span class="class"><span class="title">public</span> <span class="title">class</span> <span class="title">CustomerController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;server.port&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String serverPort;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@StreamListener</span>(Sink.INPUT)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">get</span><span class="params">(Message&lt;String&gt; message)</span> </span>&#123;</span><br><span class="line">        String output = <span class="string">"消费者:"</span> + serverPort +<span class="string">",获得的消息是："</span>+message.getPayload();</span><br><span class="line">        System.out.println(output);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<p>访问生产者<a href>http://localhost:8801/provide/send</a>，产生一条消息:</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a9841d4e-5510-4395-ada5-53edad88b5f7</span><br></pre></td></tr></table></figure>

<p>此时消费者8802接收到消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">消费者:<span class="number">8802</span>,获得的消息是：a9841d4e-<span class="number">5510</span>-<span class="number">4395</span>-ada5-<span class="number">53</span>edad88b5f7</span><br></pre></td></tr></table></figure>

<p>如果此时还有其他的消费者，比如消费者8803：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">消费者:<span class="number">8803</span>,获得的消息是：a9841d4e-<span class="number">5510</span>-<span class="number">4395</span>-ada5-<span class="number">53</span>edad88b5f7</span><br></pre></td></tr></table></figure>

<p>可见，生产者生产的一条消息，多个消费者都收到了，并且重复消费了。</p>
<h4 id="分组解决重复消费问题"><a href="#分组解决重复消费问题" class="headerlink" title="分组解决重复消费问题"></a>分组解决重复消费问题</h4><p>在Stream中，处于同一个group中的多个消费者是竞争关系，能够保证消息只会被其中一个消费者消费一次。</p>
<p>不同group是可以重复消费的。</p>
<p>查看rabbitMQ的界面，可以查看，默认情况下两个消费者属于不同的分组，因此它们可以重复消费。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220160328224.png" alt="image-group"></p>
<p>我们可以为消费者设置相同的分组，解决重复消费的问题。分别在多个消费者的配置文件中配置group:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># stream的整合配置</span></span><br><span class="line">     <span class="attr">bindings:</span></span><br><span class="line">       <span class="attr">input:</span></span><br><span class="line">         <span class="comment"># 消费者消费的消息从哪个通道取</span></span><br><span class="line">         <span class="attr">destination:</span> <span class="string">studyExchange</span></span><br><span class="line">         <span class="comment"># 消息类型，本次为json，如果是文本则设置为text/plain</span></span><br><span class="line">         <span class="attr">content-type:</span> <span class="string">text/plain</span></span><br><span class="line">         <span class="comment"># 设置要绑定的消息服务的具体设置</span></span><br><span class="line">         <span class="attr">binder:</span> <span class="string">default-rabbit</span></span><br><span class="line">         <span class="comment"># 指定分组</span></span><br><span class="line">         <span class="attr">group:</span> <span class="string">customerA</span></span><br></pre></td></tr></table></figure>

<p>重启后，生产者生产一条消息，只会被同组内的一个消费者消费。</p>
<p>查看rabbitMQ管理界面也可以看到我们设置的分组生效了：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220160757195.png" alt="image-同一个group"></p>
<h4 id="持久化问题"><a href="#持久化问题" class="headerlink" title="持久化问题"></a>持久化问题</h4><p>假设消费者的服务挂掉了，但是生产者还一直在生产消息，那么这么消息会被怎么处理呢？</p>
<ul>
<li>如果指定了分组，这些消息会被持久化，当消费者重新启动的时候，这些消息会被消费</li>
<li>如果没有指定分组，这些消息会丢失</li>
</ul>
<p>测试：</p>
<p>消费者8802不指定分组，消费者8803指定分组customerA。同时关闭消费者8802和消费者8803，访问生产者生产3条消息。重新消费者服务:</p>
<p>消费者8803指定了分组，一启动消费之前持久化的消息：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">消费者:<span class="number">8803</span>,获得的消息是：<span class="number">756</span>d6ec3-<span class="number">23</span>d3-<span class="number">4</span>af4-<span class="number">93f</span>3-<span class="number">5</span>a650ca6ee67</span><br><span class="line">消费者:<span class="number">8803</span>,获得的消息是：f37512be-f8e4-<span class="number">42f</span>4-<span class="number">9</span>a59-b53ec1e5668e</span><br><span class="line">消费者:<span class="number">8803</span>,获得的消息是：<span class="number">35</span>b57408-<span class="number">263</span>c-<span class="number">4</span>dd4-<span class="number">9</span>aa5-b0b00a5e773e</span><br></pre></td></tr></table></figure>

<p>而消费者8802重启之后，之前的消息丢失。</p>
<h3 id="Sleuth"><a href="#Sleuth" class="headerlink" title="Sleuth"></a>Sleuth</h3><hr>
<p>在微服务框架中，一个由客户端发起的请求在后端系统中会经过多个不同的服务节点调用来协同产生最后的请求结果，每一个前端请求都回形成一条复杂的分布式服务调用链路，链路中的任何一环出现高延迟或者错误都会引起整个请求最后的失败。而Sleuth就是用于追踪每个请求的整体链路。</p>
<h4 id="基本使用-1"><a href="#基本使用-1" class="headerlink" title="基本使用"></a>基本使用</h4><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-zipkin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>修改配置文件</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">cloud-order-service</span></span><br><span class="line">  <span class="attr">zipkin:</span></span><br><span class="line">    <span class="comment"># 指定数据显示在哪里</span></span><br><span class="line">    <span class="attr">base-url:</span> <span class="string">http://localhost:9411</span></span><br><span class="line">    <span class="attr">sleuth:</span></span><br><span class="line">      <span class="attr">sampler:</span></span><br><span class="line">        <span class="comment"># 采样率,介于0到1直接,1则表示全部采集</span></span><br><span class="line">        <span class="attr">probability:</span> <span class="number">1</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动java -jar java -jar zipkin-server-2.12.9-exec.jar</li>
</ol>
<p>这个jar包需要单独下载，这个jar就是图形界面的展示。</p>
<p>启动完成后，访问<a href>http://localhost:9411/zipkin/</a>,可以查看链路。</p>
<p>span指的是访问的url。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201220164008117.png" alt="image-zipkin"></p>
<h3 id="Nacos"><a href="#Nacos" class="headerlink" title="Nacos"></a>Nacos</h3><h4 id="服务提供者搭建"><a href="#服务提供者搭建" class="headerlink" title="服务提供者搭建"></a>服务提供者搭建</h4><ol>
<li>导入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件</li>
</ol>
<p>nacos不需要其他的服务注册模块了，不需要引入Eureka那一套了。</p>
<p><strong>注意server-addr的写法，写成<a href>http://47.96.224.198:8848</a>是不行的，启动会报错。</strong></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9001</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-payment-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8848</span> <span class="comment"># nacos服务器地址</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosPayment9001Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(NacosPayment9001Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>测试</li>
</ol>
<p>登录[<a href="http://47.96.224.198:8848/nacos]，账户密码默认都为nacos。可以看到服务已经完成注册了。" target="_blank" rel="noopener">http://47.96.224.198:8848/nacos]，账户密码默认都为nacos。可以看到服务已经完成注册了。</a></p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221194659396.png" alt="image-服务注册"></p>
<p>访问<a href>http://localhost:9001/payment/nacos/1</a>,返回结果符合预期。</p>
<h4 id="服务消费者搭建"><a href="#服务消费者搭建" class="headerlink" title="服务消费者搭建"></a>服务消费者搭建</h4><ol>
<li>导入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-order-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8848</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 自定义配置，要调用的服务地址</span></span><br><span class="line"><span class="attr">service-url:</span></span><br><span class="line">  <span class="attr">payment-service-url:</span> <span class="string">http://nacos-payment-service</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosOrder83Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(NacosOrder83Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>业务类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"order"</span>)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OrderController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;service-url.payment-service-url&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/nacos/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getPayment</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> restTemplate.getForObject(paymentService+<span class="string">"/payment/nacos/"</span>+id,String<span class="class">.<span class="keyword">class</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>配置类</li>
</ol>
<p>配置restTemplate，注意加上负载均衡的注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationContextConfiguration</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="meta">@LoadBalanced</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="6">
<li>测试</li>
</ol>
<p>打开nacos的管理界面，消费者order83已经完成注册。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221195103011.png" alt="image消费者完成注册"></p>
<p>访问<a href>http://localhost:83/order/nacos/1</a>,返回结果预期。多次刷新页面，打印的端口也在变化，实现了负载均衡。</p>
<h4 id="配置中心"><a href="#配置中心" class="headerlink" title="配置中心"></a>配置中心</h4><p>通过公式 <strong>${prefix}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}</strong> 从nacos中拉取配置。</p>
<blockquote>
<p>prefix默认为spring.application.name指定的值，也可以通过spring.cloud.nacos.config.prefix配置</p>
<p>spring.profiles.active为当前环境对应的profile,(dev,prod，test等)</p>
<p>file-extension为配置内容的数据格式，可以通过spring.cloud.nacos.file-extension来配置</p>
</blockquote>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221203317319.png" alt="image-配置文件命名规则"></p>
<ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-config<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件，bootstrap.yml 和 application.yml</li>
</ol>
<p>bootstrap.yml:</p>
<p>除了指定服务注册中心的地址之外，还需要执行配置中心的地址。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">3377</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">nacos-config-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="comment"># 配置中心的地址</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8848</span></span><br><span class="line">        <span class="comment"># 只支持yaml,不支持yml</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">config</span></span><br></pre></td></tr></table></figure>

<p>application.yml:</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">dev</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NacosConfig3377Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(NacosConfig3377Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>业务类</li>
</ol>
<p>通过Spring Cloud的注解@RefreshScope实现配置的自动刷新，与Spring Clound Config相比，不再需要发送post请求。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RefreshScope</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value</span>(<span class="string">"$&#123;config.info&#125;"</span>)</span><br><span class="line">    <span class="keyword">private</span> String configInfo;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/config/info"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getConfigInfo</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> configInfo;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<p>在nacos的配置中心根据${profix}-${spring.profiles.active}.${spring.cloud.nacos.config.file-extension}创建配置文件：config-dev.yaml</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221202509643.png" alt="image-config-dev.yaml"></p>
<p>启动服务nacos-config-3377，访问<a href>http://localhost:3377/config/info</a>,得到以下结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nacos config,DEFAULT_GROUP,version = 1</span><br></pre></td></tr></table></figure>

<p>从nacos的配置中心获取到了文件，尝试修改config-dev.yaml文件，将其version = 2</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">    <span class="attr">info:</span> <span class="string">nacos</span> <span class="string">config,DEFAULT_GROUP,version</span> <span class="string">=</span> <span class="number">2</span></span><br></pre></td></tr></table></figure>

<p>不需要重启服务，不需要发送post请求，再次访问<a href>http://localhost:3377/config/info</a>，配置信息自动刷新了，得到以下结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nacos config,DEFAULT_GROUP,version = 2</span><br></pre></td></tr></table></figure>

<p>假设把配置文件中的prefix: config去掉，prefix默认值为${spring.application.name}的值，创建nacos-config-service-dev.yaml文件：</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">config:</span></span><br><span class="line">    <span class="attr">info:</span> <span class="string">nacos</span> <span class="string">config,DEFAULT_GROUP,version</span> <span class="string">=</span> <span class="number">3333</span></span><br></pre></td></tr></table></figure>

<p>此时，需要重启服务，重启后访问<a href>http://localhost:3377/config/info</a>,得到以下结果：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nacos config,DEFAULT_GROUP,version = 3333</span><br></pre></td></tr></table></figure>

<h4 id="配置的隔离"><a href="#配置的隔离" class="headerlink" title="配置的隔离"></a>配置的隔离</h4><p>配置文件这里有namespace、group、DataId这3个概念，用来区分不同的环境。</p>
<p>namespace是可以用来区分部署环境的，Group和DataId逻辑上区分两个目标对象。</p>
<p><strong>默认值：</strong></p>
<p>namespace=public，group=DEFAULT_GROUP，默认Cluster(集群)是DEFAULT</p>
<p>Nacos默认的命名空间是public，namespace主要是用来实现隔离。比如说我们现在有3个环境：开发，测试，生产环境，我们就可以创建三个namespace，不同的namaspace之间是隔离的。</p>
<p>Group默认是DEFAULT_GROUP，Group可以把不同的微服务划分到同一个分组。</p>
<ol>
<li>默认namespace + DEFAULT_GROUP + 不同的DataId</li>
</ol>
<p>通过不同的DataId(即不同的配置文件名称)，通过切换spring.profiles.active的值来切换不同的配置文件。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221204841920.png" alt="image-DataId隔离配置文件"></p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line"><span class="comment">#    active: dev # 加载nacos-config-service-dev.yaml配置文件</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">prod</span> <span class="comment"># 加载nacos-config-service-prod.yaml配置文件</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>默认的namespace + 相同的DataId + 不同的Group</li>
</ol>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221205245234.png" alt="image-Group隔离配置文件"></p>
<p>通过配置文件中指定的group属性，切换不同的配置文件：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221205446832.png" alt="image-通过group切换不同配置文件"></p>
<ol start="3">
<li>不同的namespace + 相同的Group + 相同的DataId</li>
</ol>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221205756914.png" alt="image-namespace隔离配置文件"></p>
<p>通过配置文件中指定的group属性，切换不同的配置文件：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221205920721.png" alt="image-通过namespace切换不同配置文件"></p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201221210119238.png" alt="image-不同的namespace"></p>
<h4 id="Nacos集群"><a href="#Nacos集群" class="headerlink" title="Nacos集群"></a>Nacos集群</h4><p>Nacos默认使用嵌入式数据库实现数据的存储。所以，如果启动多个配置下的Nacos节点，数据存储是存在一致性问题的。为了解决这个问题，Nacos采用了集中式存储的方式来支持集群化部署，目前只支持MySql的存储。</p>
<h3 id="Sentinel"><a href="#Sentinel" class="headerlink" title="Sentinel"></a>Sentinel</h3><h4 id="基本使用-2"><a href="#基本使用-2" class="headerlink" title="基本使用"></a>基本使用</h4><ol>
<li>引入依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-sentinel<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>配置文件</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">8401</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sentinel-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="comment"># dashboard地址</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8080</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>启动类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="meta">@EnableDiscoveryClient</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sentinel8401Application</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        SpringApplication.run(Sentinel8401Application<span class="class">.<span class="keyword">class</span>, <span class="title">args</span>)</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="4">
<li>业务类</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/testA"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"------&gt;testA"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/testB"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testB</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"------&gt;testB"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>测试</li>
</ol>
<p>sentinel默认是懒加载的，只有访问了url之后，页面才会有显示。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222200953755.png" alt="image-sentinel控制台"></p>
<h4 id="流控规则"><a href="#流控规则" class="headerlink" title="流控规则"></a>流控规则</h4><p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222201255069.png" alt="image-新增流控规则"></p>
<p>上面的配置表示，当访问/testA时，每秒钟的访问量超过1（阈值），后面的请求就直接失败，快速失败默认的处理方式是抛出异常。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Blocked by Sentinel (flow limiting)</span><br></pre></td></tr></table></figure>

<p>这里有关QPS和线程数的说明：</p>
<ul>
<li>QPS：每秒的请求数量，和时间有关</li>
<li>线程数：跟线程的数量有关，当线程数量超过阈值，会进行限流</li>
</ul>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222203120210.png" alt="image-线程数的配置"></p>
<p>如果流控模式选择关联，当关联的资源达到阈值，就限流自己。</p>
<p>比如支付接口达到阈值，就要限流订单接口。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222203702580.png" alt="image-关联"></p>
<p>warm up：根据codeFactory（冷加载因子，默认3）的值，从阈值codeFactory经过预热时长，才达到设置的QPS阈值。</p>
<p>应用场景：秒杀系统在开启的瞬间，会有很多流量上来，很有可能把系统打死，预热方式就是为了保护系统，可慢慢的把流量放进了，慢慢的把阈值增长到设置的阈值。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222204548485.png" alt="image-预热"></p>
<p>排队等待：让请求以均匀的速度通过，阈值类型必须设置成QPS，否则无效。</p>
<p>应用场景：用于处理间隔性突发的流量，比如消息队列。在某一秒有大量的请求到来，而接下来的几秒则处于空闲状态，我们希望系统能够在接下来的空闲期间逐渐处理这些请求，而不是在第一秒直接拒绝多余的请求。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201222205812768.png" alt="image-排队等待"></p>
<h4 id="SentinelResource"><a href="#SentinelResource" class="headerlink" title="SentinelResource"></a>SentinelResource</h4><p>使用@SentinelResource可以自定义异常处理方法。类似于Hystrix的@HystrixCommand.</p>
<p>@SententinelResource的value属性可以指定资源名称，在sentinel界面配置流控规则的时候，可以使用资源名称，也可以使用url。</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201223205817336.png" alt="image-使用资源名称配置流控规则"></p>
<p>使用blockHandler属性指明自定义的处理方法。当/testA(testA)被限流的时候，会进入到自定义的处理方法。自定义处理方法可以绑定一个BlockException。<strong>标记@SentinelResource的方法形参有什么参数，自定义的处理方法也要有对应的形参。</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/testA"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"testA"</span>,blockHandler = <span class="string">"handlerException"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"------&gt;testA"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handlerException</span><span class="params">(BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"自定义的处理方法...,发生错误:"</span> + e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为了代码的耦合性低，可以将自定义方法写在一个类中，使用blockHandlerClass属性指明自定义方法所在的类，blockHandler指明要处理的自定义方法。</p>
<p>只要标明了blockHandlerClass属性，就会到对应的类中去查找自定义方法，即使本类中指定了同名的自定义方法也无效。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/testA"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"testA"</span>,blockHandlerClass = CustomerHandler<span class="class">.<span class="keyword">class</span>,<span class="title">blockHandler</span> </span>= <span class="string">"handlerException"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"------&gt;testA"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handlerException</span><span class="params">(BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"本类中的自定义的处理方法...,发生错误:"</span> + e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomerHander是自定义所在方法的类。<strong>类中的自定义处理方法必须使用static修饰。</strong></p>
<p>自定义处理方法类无需加入容器。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CustomerHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">handlerException</span><span class="params">(BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"自定义类中的自定义的处理方法...,发生错误:"</span> + e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果在@SentinelResource内属性blockHandler没有识别到匹配的方法，会将属性fallback的内容替代blockHandler内容.</p>
<p>fallback指定的自定义方法上，异常对象绑定的是Throwable，如果绑定BlockException会报错。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLimitController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/testA"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"testA"</span>,blockHandler = <span class="string">"handlerException111"</span>,fallback = <span class="string">"fallbackHandler"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">testA</span><span class="params">()</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="string">"------&gt;testA"</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">handlerException</span><span class="params">(BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"本类中的自定义的处理方法...,发生错误:"</span> + e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fallbackHandler</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"如果在@SentinelResource内属性blockHandler没有识别到匹配的方法，会将属性fallback的内容替代blockHandler内容:"</span>+ e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>小结：</p>
<ul>
<li><p><strong>标记@SentinelResource的方法形参有什么参数，自定义的处理方法也要有对应的形参。</strong></p>
</li>
<li><p><strong>类中的自定义处理方法必须使用static修饰。</strong></p>
</li>
<li><p><strong>如果在@SentinelResource内属性blockHandler没有识别到匹配的方法，会将属性fallback的内容替代blockHandler内容.</strong></p>
</li>
<li><p><strong>如果使用了@SentinelResource的value属性标记了资源名，流控规则不能配置为url的路径了。</strong></p>
</li>
<li><p><strong>如果出现了message not variable的错误，很有可能的自定义方法的形参绑定错误了。</strong></p>
</li>
<li><p><strong>流控规则不是持久化的，当重启了服务，配置的流控规则就会消失</strong></p>
</li>
<li><p><strong>标记@SentinelResource的方法不能是private</strong></p>
</li>
</ul>
<h4 id="fallback和blockHandler"><a href="#fallback和blockHandler" class="headerlink" title="fallback和blockHandler"></a>fallback和blockHandler</h4><p>fallback指定的方法主要用来处理java中发生的异常，blockHandler指定的方法主要用来处理sentinel中规则的异常。</p>
<blockquote>
<ol>
<li>只指定fallback</li>
</ol>
</blockquote>
<p>如果只指定了fallback方法，发生java异常会执行fallback指定的方法。</p>
<p>如果此时又违反了sentinel的规则，sentinel默认快速失败抛出的异常也会被fallback捕捉到进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/payment/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"test"</span>,fallback = <span class="string">"fallbackHandler"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentService.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">limitHandler</span><span class="params">(String id, BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"limitHandler处理sentinel配置的规则，e:"</span> + e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="2">
<li>只指定blockHandler方法</li>
</ol>
</blockquote>
<p>如果出现java异常，没有fallback方法处理，会直接在浏览器页面抛出异常。</p>
<p>如果违反了sentinel配置的规则，会进入blockHandler指定的方法进行处理。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/payment/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"test"</span>,blockHandler = <span class="string">"limitHandler"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentService.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">limitHandler</span><span class="params">(String id, BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"limitHandler处理sentinel配置的规则，e:"</span> + e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<blockquote>
<ol start="3">
<li>指定fallback和blockhandler</li>
</ol>
</blockquote>
<p>出现的java异常通过fallback指定的方法处理，违反sentinel规则的通过blockHandler指定的方法处理。</p>
<p>但如果同时出现java异常和违反sentinel规则，则blockHandler指定的方法优先级高于fallback指定的方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PaymentController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> PaymentService paymentService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/payment/&#123;id&#125;"</span>)</span><br><span class="line">    <span class="meta">@SentinelResource</span>(value = <span class="string">"test"</span>,fallback = <span class="string">"fallbackHandler"</span>,blockHandler = <span class="string">"limitHandler"</span>)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">get</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> String id) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> paymentService.get(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">fallbackHandler</span><span class="params">(String id, Throwable e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"fallbackHandler处理java中的异常，e:"</span> + e;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">limitHandler</span><span class="params">(String id, BlockException e)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">"limitHandler处理sentinel配置的规则，e:"</span> + e;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="持久化配置"><a href="#持久化配置" class="headerlink" title="持久化配置"></a>持久化配置</h4><p>默认情况下，服务重启后，之前配置的流控规则等就会消失，可以将其保存到nacos持久化保存。</p>
<ol>
<li>添加持久化依赖</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.csp<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sentinel-datasource-nacos<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>添加配置</li>
</ol>
<p>在配置文件中指明持久化的配置位于nacos配置中心的namespace、group、dataId等属性。</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">9003</span></span><br><span class="line"></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">sentinel-payment-service</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8848</span></span><br><span class="line">    <span class="attr">sentinel:</span></span><br><span class="line">      <span class="attr">transport:</span></span><br><span class="line">        <span class="attr">dashboard:</span> <span class="string">localhost:8080</span></span><br><span class="line">      <span class="comment"># 持久化设置</span></span><br><span class="line">      <span class="attr">datasource:</span></span><br><span class="line">        <span class="attr">datasource1:</span></span><br><span class="line">          <span class="attr">nacos:</span></span><br><span class="line">            <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8848</span></span><br><span class="line">            <span class="attr">dataId:</span> <span class="string">sentinel-payment-service</span></span><br><span class="line">            <span class="attr">groupId:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">            <span class="attr">data-type:</span> <span class="string">json</span></span><br><span class="line">            <span class="attr">rule-type:</span> <span class="string">flow</span></span><br><span class="line"><span class="attr">management:</span></span><br><span class="line">  <span class="attr">endpoints:</span></span><br><span class="line">    <span class="attr">web:</span></span><br><span class="line">      <span class="attr">exposure:</span></span><br><span class="line">        <span class="attr">include:</span> <span class="string">"*"</span></span><br></pre></td></tr></table></figure>

<ol start="3">
<li>在nacos配置中心添加文件</li>
</ol>
<p><img src="C:%5CUsers%5Czjm16%5CAppData%5CRoaming%5CTypora%5Ctypora-user-images%5Cimage-20201224223359921.png" alt="image-nacos持久化配置"></p>
<p>关于参数的介绍：</p>
<blockquote>
<p>resource:资源名称，也可以指定url的路径</p>
<p>limitApp:来源应用</p>
<p>grade:阈值类型，0表示线程数，1表示QPS</p>
<p>count:单机阈值</p>
<p>strategy:流控模式，0表示直接，1表示关联，2表示链路</p>
<p>controlBehavior:流控效果，0表示快速失败，1表示Warm up，2表示排队等待</p>
<p>clusterMode:是否集群</p>
</blockquote>
<h3 id="seata"><a href="#seata" class="headerlink" title="seata"></a>seata</h3><h4 id="server端配置"><a href="#server端配置" class="headerlink" title="server端配置"></a>server端配置</h4><ol>
<li>修改file.conf和registry.conf文件</li>
</ol>
<p>在进行文件修改之前，先备份。</p>
<p>file.conf:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># transaction log store, only used in seata-server</span></span></span><br><span class="line">store &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># store mode: file、db、redis  存储模式修改为db</span></span></span><br><span class="line">  mode = "db"</span><br><span class="line"></span><br><span class="line"><span class="meta">  #</span><span class="bash"><span class="comment"># file store property</span></span></span><br><span class="line">  file &#123;</span><br><span class="line">    ## store location dir</span><br><span class="line">    dir = "sessionStore"</span><br><span class="line">    # branch session size , if exceeded first try compress lockkey, still exceeded throws exceptions</span><br><span class="line">    maxBranchSessionSize = 16384</span><br><span class="line">    # globe session size , if exceeded throws exceptions</span><br><span class="line">    maxGlobalSessionSize = 512</span><br><span class="line">    # file buffer size , if exceeded allocate new buffer</span><br><span class="line">    fileWriteBufferCacheSize = 16384</span><br><span class="line">    # when recover batch read size</span><br><span class="line">    sessionReloadReadSize = 100</span><br><span class="line">    # async, sync</span><br><span class="line">    flushDiskMode = async</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># database store property</span></span></span><br><span class="line">  db &#123;</span><br><span class="line">    ## the implement of javax.sql.DataSource, such as DruidDataSource(druid)/BasicDataSource(dbcp)/HikariDataSource(hikari) etc.</span><br><span class="line">    datasource = "druid"</span><br><span class="line">    ## mysql/oracle/postgresql/h2/oceanbase etc.</span><br><span class="line">    dbType = "mysql"</span><br><span class="line">    driverClassName = "com.mysql.jdbc.Driver"</span><br><span class="line">    url = "jdbc:mysql://localhost:3306/seata"  # 需要创建seata库，并导入sql语句，生成3张表</span><br><span class="line">    user = "root"</span><br><span class="line">    password = "123"</span><br><span class="line">    minConn = 5</span><br><span class="line">    maxConn = 100</span><br><span class="line">    globalTable = "global_table"</span><br><span class="line">    branchTable = "branch_table"</span><br><span class="line">    lockTable = "lock_table"</span><br><span class="line">    queryLimit = 100</span><br><span class="line">    maxWait = 5000</span><br><span class="line">  &#125;</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="comment"># redis store property</span></span></span><br><span class="line">  redis &#123;</span><br><span class="line">    host = "127.0.0.1"</span><br><span class="line">    port = "6379"</span><br><span class="line">    password = ""</span><br><span class="line">    database = "0"</span><br><span class="line">    minConn = 1</span><br><span class="line">    maxConn = 10</span><br><span class="line">    maxTotal = 100</span><br><span class="line">    queryLimit = 100</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>registry.conf:</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">registry &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> file 、nacos 、eureka、redis、zk、consul、etcd3、sofa</span></span><br><span class="line">  type = "nacos"  # 注册中心使用nacos</span><br><span class="line">  loadBalance = "RandomLoadBalance"</span><br><span class="line">  loadBalanceVirtualNodes = 10</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    application = "seata-server"  # seata作为注册中心的一个服务，服务名称叫什么</span><br><span class="line">    serverAddr = "localhost:8848" # nacos注册中心地址</span><br><span class="line">    group = "SEATA_GROUP" # 服务分组，不是配置分组</span><br><span class="line">    namespace = "" # 服务注册时的命名空间，不填为默认的public</span><br><span class="line">    cluster = "default" # 不用改</span><br><span class="line">    username = "nacos"</span><br><span class="line">    password = "nacos"</span><br><span class="line">  &#125;</span><br><span class="line">  eureka &#123;</span><br><span class="line">    serviceUrl = "http://localhost:8761/eureka"</span><br><span class="line">    application = "default"</span><br><span class="line">    weight = "1"</span><br><span class="line">  &#125;</span><br><span class="line">  redis &#123;</span><br><span class="line">    serverAddr = "localhost:6379"</span><br><span class="line">    db = 0</span><br><span class="line">    password = ""</span><br><span class="line">    cluster = "default"</span><br><span class="line">    timeout = 0</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    cluster = "default"</span><br><span class="line">    serverAddr = "127.0.0.1:2181"</span><br><span class="line">    sessionTimeout = 6000</span><br><span class="line">    connectTimeout = 2000</span><br><span class="line">    username = ""</span><br><span class="line">    password = ""</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    cluster = "default"</span><br><span class="line">    serverAddr = "127.0.0.1:8500"</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    cluster = "default"</span><br><span class="line">    serverAddr = "http://localhost:2379"</span><br><span class="line">  &#125;</span><br><span class="line">  sofa &#123;</span><br><span class="line">    serverAddr = "127.0.0.1:9603"</span><br><span class="line">    application = "default"</span><br><span class="line">    region = "DEFAULT_ZONE"</span><br><span class="line">    datacenter = "DefaultDataCenter"</span><br><span class="line">    cluster = "default"</span><br><span class="line">    group = "SEATA_GROUP"</span><br><span class="line">    addressWaitTime = "3000"</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = "file.conf"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">config &#123;</span><br><span class="line"><span class="meta">  #</span><span class="bash"> file、nacos 、apollo、zk、consul、etcd3</span></span><br><span class="line">  type = "nacos" # 配置中心使用nacos</span><br><span class="line"></span><br><span class="line">  nacos &#123;</span><br><span class="line">    serverAddr = "localhost:8848" # nasos配置中心的地址</span><br><span class="line">    namespace = "" # 配置中心的命名空间</span><br><span class="line">    group = "SEATA_GROUP" </span><br><span class="line">    username = "nacos"</span><br><span class="line">    password = "nacos"</span><br><span class="line">  &#125;</span><br><span class="line">  consul &#123;</span><br><span class="line">    serverAddr = "127.0.0.1:8500"</span><br><span class="line">  &#125;</span><br><span class="line">  apollo &#123;</span><br><span class="line">    appId = "seata-server"</span><br><span class="line">    apolloMeta = "http://192.168.1.204:8801"</span><br><span class="line">    namespace = "application"</span><br><span class="line">    apolloAccesskeySecret = ""</span><br><span class="line">  &#125;</span><br><span class="line">  zk &#123;</span><br><span class="line">    serverAddr = "127.0.0.1:2181"</span><br><span class="line">    sessionTimeout = 6000</span><br><span class="line">    connectTimeout = 2000</span><br><span class="line">    username = ""</span><br><span class="line">    password = ""</span><br><span class="line">  &#125;</span><br><span class="line">  etcd3 &#123;</span><br><span class="line">    serverAddr = "http://localhost:2379"</span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    name = "file.conf"</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>执行sql，导入seata的3张表</li>
</ol>
<p>创建一个数据库seata，这与file.conf文件中的指定属性相同。</p>
<p>导入db_store.sql</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- the table to store GlobalSession data</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`global_table`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`global_table`</span> (</span><br><span class="line">	<span class="string">`xid`</span> <span class="built_in">VARCHAR</span> (<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`transaction_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">	<span class="string">`status`</span> <span class="built_in">TINYINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`application_id`</span> <span class="built_in">VARCHAR</span> (<span class="number">32</span>),</span><br><span class="line">	<span class="string">`transaction_service_group`</span> <span class="built_in">VARCHAR</span> (<span class="number">32</span>),</span><br><span class="line">	<span class="string">`transaction_name`</span> <span class="built_in">VARCHAR</span> (<span class="number">128</span>),</span><br><span class="line">	<span class="string">`timeout`</span> <span class="built_in">INT</span>,</span><br><span class="line">	<span class="string">`begin_time`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">	<span class="string">`application_data`</span> <span class="built_in">VARCHAR</span> (<span class="number">2000</span>),</span><br><span class="line">	<span class="string">`gmt_create`</span> datetime,</span><br><span class="line">	<span class="string">`gmt_modified`</span> datetime,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`xid`</span>),</span><br><span class="line">	<span class="keyword">KEY</span> <span class="string">`idx_gmt_modified_status`</span> (<span class="string">`gmt_modified`</span>, <span class="string">`status`</span>),</span><br><span class="line">	<span class="keyword">KEY</span> <span class="string">`idx_transaction_id`</span> (<span class="string">`transaction_id`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store BranchSession data</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`branch_table`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`branch_table`</span> (</span><br><span class="line">	<span class="string">`branch_id`</span> <span class="built_in">BIGINT</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`xid`</span> <span class="built_in">VARCHAR</span> (<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`transaction_id`</span> <span class="built_in">BIGINT</span>,</span><br><span class="line">	<span class="string">`resource_group_id`</span> <span class="built_in">VARCHAR</span> (<span class="number">32</span>),</span><br><span class="line">	<span class="string">`resource_id`</span> <span class="built_in">VARCHAR</span> (<span class="number">256</span>),</span><br><span class="line">	<span class="string">`lock_key`</span> <span class="built_in">VARCHAR</span> (<span class="number">128</span>),</span><br><span class="line">	<span class="string">`branch_type`</span> <span class="built_in">VARCHAR</span> (<span class="number">8</span>),</span><br><span class="line">	<span class="string">`status`</span> <span class="built_in">TINYINT</span>,</span><br><span class="line">	<span class="string">`client_id`</span> <span class="built_in">VARCHAR</span> (<span class="number">64</span>),</span><br><span class="line">	<span class="string">`application_data`</span> <span class="built_in">VARCHAR</span> (<span class="number">2000</span>),</span><br><span class="line">	<span class="string">`gmt_create`</span> datetime,</span><br><span class="line">	<span class="string">`gmt_modified`</span> datetime,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`branch_id`</span>),</span><br><span class="line">	<span class="keyword">KEY</span> <span class="string">`idx_xid`</span> (<span class="string">`xid`</span>)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- the table to store lock data</span></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span></span><br><span class="line"><span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`lock_table`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`lock_table`</span> (</span><br><span class="line">	<span class="string">`row_key`</span> <span class="built_in">VARCHAR</span> (<span class="number">128</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">	<span class="string">`xid`</span> <span class="built_in">VARCHAR</span> (<span class="number">96</span>),</span><br><span class="line">	<span class="string">`transaction_id`</span> <span class="keyword">LONG</span>,</span><br><span class="line">	<span class="string">`branch_id`</span> <span class="keyword">LONG</span>,</span><br><span class="line">	<span class="string">`resource_id`</span> <span class="built_in">VARCHAR</span> (<span class="number">256</span>),</span><br><span class="line">	<span class="string">`table_name`</span> <span class="built_in">VARCHAR</span> (<span class="number">32</span>),</span><br><span class="line">	<span class="string">`pk`</span> <span class="built_in">VARCHAR</span> (<span class="number">36</span>),</span><br><span class="line">	<span class="string">`gmt_create`</span> datetime,</span><br><span class="line">	<span class="string">`gmt_modified`</span> datetime,</span><br><span class="line">	PRIMARY <span class="keyword">KEY</span> (<span class="string">`row_key`</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>将配置文件导入nacos</li>
</ol>
<p>config.txt是seata各种详细的配置，执行 nacos-config.sh 即可将这些配置导入到nacos，这样就不需要将file.conf和registry.conf放到我们client端的项目中了，需要什么配置就直接从nacos中读取。</p>
<p>config.txt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">transport.type=TCP</span><br><span class="line">transport.server=NIO</span><br><span class="line">transport.heartbeat=true</span><br><span class="line">transport.thread-factory.boss-thread-prefix=NettyBoss</span><br><span class="line">transport.thread-factory.worker-thread-prefix=NettyServerNIOWorker</span><br><span class="line">transport.thread-factory.server-executor-thread-prefix=NettyServerBizHandler</span><br><span class="line">transport.thread-factory.share-boss-worker=false</span><br><span class="line">transport.thread-factory.client-selector-thread-prefix=NettyClientSelector</span><br><span class="line">transport.thread-factory.client-selector-thread-size=1</span><br><span class="line">transport.thread-factory.client-worker-thread-prefix=NettyClientWorkerThread</span><br><span class="line">transport.thread-factory.boss-thread-size=1</span><br><span class="line">transport.thread-factory.worker-thread-size=8</span><br><span class="line">transport.shutdown.wait=3</span><br><span class="line"># nacos配置中心和springboot中的值都需要和这里一致</span><br><span class="line">service.vgroup_mapping.my_test_tx_group=default</span><br><span class="line">service.enableDegrade=false</span><br><span class="line">service.disable=false</span><br><span class="line">service.max.commit.retry.timeout=-1</span><br><span class="line">service.max.rollback.retry.timeout=-1</span><br><span class="line">client.async.commit.buffer.limit=10000</span><br><span class="line">client.lock.retry.internal=10</span><br><span class="line">client.lock.retry.times=30</span><br><span class="line">client.lock.retry.policy.branch-rollback-on-conflict=true</span><br><span class="line">client.table.meta.check.enable=true</span><br><span class="line">client.report.retry.count=5</span><br><span class="line">client.tm.commit.retry.count=1</span><br><span class="line">client.tm.rollback.retry.count=1</span><br><span class="line">store.mode=file</span><br><span class="line">store.file.dir=file_store/data</span><br><span class="line">store.file.max-branch-session-size=16384</span><br><span class="line">store.file.max-global-session-size=512</span><br><span class="line">store.file.file-write-buffer-cache-size=16384</span><br><span class="line">store.file.flush-disk-mode=async</span><br><span class="line">store.file.session.reload.read_size=100</span><br><span class="line">store.db.datasource=dbcp</span><br><span class="line"></span><br><span class="line">store.db.datasource=druid</span><br><span class="line">store.db.db-type=mysql</span><br><span class="line">store.db.driver-class-name=com.mysql.jdbc.Driver</span><br><span class="line">store.db.url=jdbc:mysql://127.0.0.1:3306/seata?useUnicode=true</span><br><span class="line">store.db.user=root</span><br><span class="line">store.db.password=123</span><br><span class="line"></span><br><span class="line">store.db.min-conn=1</span><br><span class="line">store.db.max-conn=3</span><br><span class="line">store.db.global.table=global_table</span><br><span class="line">store.db.branch.table=branch_table</span><br><span class="line">store.db.query-limit=100</span><br><span class="line">store.db.lock-table=lock_table</span><br><span class="line">recovery.committing-retry-period=1000</span><br><span class="line">recovery.asyn-committing-retry-period=1000</span><br><span class="line">recovery.rollbacking-retry-period=1000</span><br><span class="line">recovery.timeout-retry-period=1000</span><br><span class="line">transaction.undo.data.validation=true</span><br><span class="line">transaction.undo.log.serialization=jackson</span><br><span class="line">transaction.undo.log.save.days=7</span><br><span class="line">transaction.undo.log.delete.period=86400000</span><br><span class="line">transaction.undo.log.table=undo_log</span><br><span class="line">transport.serialization=seata</span><br><span class="line">transport.compressor=none</span><br><span class="line">metrics.enabled=false</span><br><span class="line">metrics.registry-type=compact</span><br><span class="line">metrics.exporter-list=prometheus</span><br><span class="line">metrics.exporter-prometheus-port=9898</span><br><span class="line">support.spring.datasource.autoproxy=false</span><br></pre></td></tr></table></figure>

<p>使用nacos-config.sh将配置导入到nacos的配置中心。</p>
<p>如果nacos-config.sh不是可执行文件，需要增加权限 chmod 777 nacos-config.sh</p>
<p>config存放的目录位于nacos-config.sh的上一级目录。</p>
<ul>
<li>config.txt : /usr/local/seata/seata</li>
<li>config-config.sh : /usr/local/seata/seata/conf</li>
</ul>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sh nacos-config.sh -h localhost -p 8848 -g SEATA_GROUP -t 7ff58f98-79e2-41ad-b96e-a2721c7864af</span><br></pre></td></tr></table></figure>

<p>参数说明：</p>
<p>-h: host，默认值 localhost</p>
<p>-p: port，默认值 8848</p>
<p>-g: 配置分组，默认值为 ‘SEATA_GROUP’</p>
<p>-t: 租户信息，对应 Nacos 的命名空间ID字段, 默认值为空 ‘’</p>
<ol start="4">
<li>创建logs文件夹</li>
</ol>
<p>在/usr/local/seata/seata目录下创建文件夹logs，并在logs下创建seata_gc.log文件</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201228214652142.png" alt="image-logs文件夹"></p>
<ol start="5">
<li>启动seata</li>
</ol>
<p>在bin目录下./seata-server.sh启动。</p>
<p>如果启动的时候报内存不足的错误，可以修改seata-server.sh文件，修改其中一行的配置。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">exec "$JAVACMD" $JAVA_OPTS -server -Xmx256m -Xms256m -Xmn256m -Xss512k</span><br></pre></td></tr></table></figure>

<p>出现以下提示说明启动成功：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201228214951974.png" alt="image-seata启动"></p>
<p>此时，查看nacos：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201228215112833.png" alt="image-nacos中查看seata服务"></p>
<p>registry.conf的其中一段配置：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">nacos &#123;</span><br><span class="line">    application = "seata-server"</span><br><span class="line">    serverAddr = "localhost:8848"</span><br><span class="line">    group = "SEATA_GROUP"</span><br><span class="line">    namespace = "7ff58f98-79e2-41ad-b96e-a2721c7864af"</span><br><span class="line">    cluster = "default"</span><br><span class="line">    username = "nacos"</span><br><span class="line">    password = "nacos"</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>查看nacos的配置中心：</p>
<p><img src="https://jinming8.oss-cn-shenzhen.aliyuncs.com/img/image-20201228215401610.png" alt="image-nacos查看seata的配置"></p>
<h4 id="client端配置"><a href="#client端配置" class="headerlink" title="client端配置"></a>client端配置</h4><ol>
<li>需要使用seata的客户端需要引入依赖，版本依赖于父级POM</li>
</ol>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-seata<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-alibaba-nacos-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ol start="2">
<li>导入undo_log</li>
</ol>
<ol start="3">
<li>springboot配置文件</li>
</ol>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">seata:</span></span><br><span class="line">  <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">enable-auto-data-source-proxy:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">tx-service-group:</span> <span class="string">my_test_tx_group</span> <span class="comment"># 事务群组（可以每个应用独立取名，也可以使用相同的名字）</span></span><br><span class="line">  <span class="attr">client:</span></span><br><span class="line">    <span class="attr">rm-report-success-enable:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">rm-table-meta-check-enable:</span> <span class="literal">false</span> <span class="comment"># 自动刷新缓存中的表结构（默认false）</span></span><br><span class="line">    <span class="attr">rm-report-retry-count:</span> <span class="number">5</span> <span class="comment"># 一阶段结果上报TC重试次数（默认5）</span></span><br><span class="line">    <span class="attr">rm-async-commit-buffer-limit:</span> <span class="number">1000</span> <span class="comment"># 异步提交缓存队列长度（默认10000）</span></span><br><span class="line">    <span class="attr">rm:</span></span><br><span class="line">      <span class="attr">lock:</span></span><br><span class="line">        <span class="attr">lock-retry-internal:</span> <span class="number">10</span> <span class="comment"># 校验或占用全局锁重试间隔（默认10ms）</span></span><br><span class="line">        <span class="attr">lock-retry-times:</span>    <span class="number">30</span> <span class="comment"># 校验或占用全局锁重试次数（默认30）</span></span><br><span class="line">        <span class="attr">lock-retry-policy-branch-rollback-on-conflict:</span> <span class="literal">true</span> <span class="comment"># 分支事务与其它全局回滚事务冲突时锁策略（优先释放本地锁让回滚成功）</span></span><br><span class="line">    <span class="attr">tm-commit-retry-count:</span>   <span class="number">3</span> <span class="comment"># 一阶段全局提交结果上报TC重试次数（默认1次，建议大于1）</span></span><br><span class="line">    <span class="attr">tm-rollback-retry-count:</span> <span class="number">3</span> <span class="comment"># 一阶段全局回滚结果上报TC重试次数（默认1次，建议大于1）</span></span><br><span class="line">    <span class="attr">undo:</span></span><br><span class="line">      <span class="attr">undo-data-validation:</span> <span class="literal">true</span> <span class="comment"># 二阶段回滚镜像校验（默认true开启）</span></span><br><span class="line">      <span class="attr">undo-log-serialization:</span> <span class="string">jackson</span> <span class="comment"># undo序列化方式（默认jackson）</span></span><br><span class="line">      <span class="attr">undo-log-table:</span> <span class="string">undo_log</span>  <span class="comment"># 自定义undo表名（默认undo_log）</span></span><br><span class="line">    <span class="attr">log:</span></span><br><span class="line">      <span class="attr">exceptionRate:</span> <span class="number">100</span> <span class="comment"># 日志异常输出概率（默认100）</span></span><br><span class="line">    <span class="attr">support:</span></span><br><span class="line">      <span class="attr">spring-datasource-autoproxy:</span> <span class="literal">true</span> <span class="comment"># 数据源自动代理开关（默认false关闭）</span></span><br><span class="line">  <span class="attr">service:</span></span><br><span class="line">    <span class="attr">vgroup-mapping:</span></span><br><span class="line">      <span class="attr">my_test_tx_group:</span> <span class="string">default</span> <span class="comment"># TC 集群（必须与seata-server保持一致）</span></span><br><span class="line">    <span class="attr">enable-degrade:</span> <span class="literal">false</span> <span class="comment"># 降级开关</span></span><br><span class="line">    <span class="attr">disable-global-transaction:</span> <span class="literal">false</span> <span class="comment"># 禁用全局事务（默认false）</span></span><br><span class="line">  <span class="attr">transport:</span></span><br><span class="line">    <span class="attr">enable-client-batch-send-request:</span> <span class="literal">true</span> <span class="comment"># 客户端事务消息请求是否批量合并发送（默认true）</span></span><br><span class="line">  <span class="comment"># 注册中心</span></span><br><span class="line">  <span class="attr">registry:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">application:</span> <span class="string">seata-server</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">  <span class="comment"># 配置中心</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">nacos</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">server-addr:</span> <span class="number">47.96</span><span class="number">.224</span><span class="number">.198</span><span class="string">:8848</span></span><br><span class="line">      <span class="attr">group:</span> <span class="string">SEATA_GROUP</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">nacos</span></span><br><span class="line">      <span class="attr">namespace:</span> <span class="string">7ff58f98-79e2-41ad-b96e-a2721c7864af</span></span><br></pre></td></tr></table></figure>

<p>方法一 你可以通过file.conf来配置使用环境<br>file.conf如以下修改<br>vgroup_mapping.xxxx-fescar-service-group = “default”<br>xxx是你的application名</p>
<p>方法二 通过环境变量改变使用环境配置<br>在启动脚本追加以下命令<br>export SEATA_CONFIG_ENV=default</p>
<p>registry.conf 对应的是 default<br>registry-dev.conf 对应 dev开发环境<br>registry-test.conf 对应 test测试环境<br>registry-prod.conf 对应 prod生产环境</p>

    </div>

    
    
    
        
      
        <div id="reward-container">
  <div>一毛也是爱~</div>
  <button id="reward-button" disable="enable" onclick="var qr = document.getElementById(&quot;qr&quot;); qr.style.display = (qr.style.display === 'none') ? 'block' : 'none';">
    打赏
  </button>
  <div id="qr" style="display: none;">
        
      
      <div style="display: inline-block">
        <img src="/images/wechatpay.jpg" alt="Kim.Zhang 微信支付">
        <p>微信支付</p>
      </div>

  </div>
</div>

      

      <footer class="post-footer">

        
  <div class="post-widgets">
    <div class="social-share">
      
      
        <div id="needsharebutton-postbottom">
          <span class="btn">
            <i class="fa fa-share-alt" aria-hidden="true"></i>
          </span>
        </div>
      
    </div>
  
  </div>

          <div class="post-nav">
            <div class="post-nav-next post-nav-item">
              
                <a href="/2021/11/21/Mysql/索引/" rel="next" title="">
                  <i class="fa fa-chevron-left"></i> 
                </a>
              
            </div>

            <span class="post-nav-divider"></span>

            <div class="post-nav-prev post-nav-item">
              
                <a href="/2021/11/21/Spring Cloud/Docker/" rel="prev" title="">
                   <i class="fa fa-chevron-right"></i>
                </a>
              
            </div>
          </div>
        
      </footer>
    
  </div>
  
  
  
  </article>

  </div>


          </div>
          

        </div>
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-overview">

          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image"
      src="/images/1.jpg"
      alt="Kim.Zhang">
  <p class="site-author-name" itemprop="name">Kim.Zhang</p>
  <div class="site-description motion-element" itemprop="description">且行且珍惜</div>
</div>
  <nav class="site-state motion-element">
      <div class="site-state-item site-state-posts">
        
          <a href="/archives/">
        
          <span class="site-state-item-count">94</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
    
      
      
      <div class="site-state-item site-state-categories">
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span>
        
      </div>
    
      
      
      <div class="site-state-item site-state-tags">
        
          
            <a href="/tags/">
          
        
        
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
          
        
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span>
        </a>
      </div>
    
  </nav>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="mailto:woshizhangjinming@vip.qq.com" title="E-Mail &rarr; mailto:woshizhangjinming@vip.qq.com" rel="noopener" target="_blank"><i class="fa fa-fw fa-envelope"></i>E-Mail</a>
      </span>
    
      <span class="links-of-author-item">
      
      
        
      
      
        
      
        <a href="https://weibo.com/6196561949" title="Weibo &rarr; https://weibo.com/6196561949" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
      </span>
    
  </div>



        </div>
      </div>
      <!--noindex-->
        <div class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
            
            
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#微服务架构理论入门"><span class="nav-number">1.</span> <span class="nav-text">微服务架构理论入门</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#微服务概念"><span class="nav-number">1.1.</span> <span class="nav-text">微服务概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SpringCloud概念"><span class="nav-number">1.2.</span> <span class="nav-text">SpringCloud概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#版本选型"><span class="nav-number">1.3.</span> <span class="nav-text">版本选型</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringBoot版本选型"><span class="nav-number">1.3.1.</span> <span class="nav-text">SpringBoot版本选型</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SpringCloud版本选型"><span class="nav-number">1.3.2.</span> <span class="nav-text">SpringCloud版本选型</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#停更的影响"><span class="nav-number">2.</span> <span class="nav-text">停更的影响</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#工程搭建"><span class="nav-number">3.</span> <span class="nav-text">工程搭建</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#dependencyManagement"><span class="nav-number">3.1.</span> <span class="nav-text">dependencyManagement</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#基础pom-xml"><span class="nav-number">3.2.</span> <span class="nav-text">基础pom.xml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#微服务模块创建"><span class="nav-number">3.3.</span> <span class="nav-text">微服务模块创建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#mybatis-mapper文件模板"><span class="nav-number">3.4.</span> <span class="nav-text">mybatis mapper文件模板</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建时的几个小坑"><span class="nav-number">3.5.</span> <span class="nav-text">构建时的几个小坑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#devtool热部署"><span class="nav-number">3.6.</span> <span class="nav-text">devtool热部署</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Run-Dashboard的配置"><span class="nav-number">3.7.</span> <span class="nav-text">Run Dashboard的配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#maven出现KIX-path-building-failed"><span class="nav-number">3.8.</span> <span class="nav-text">maven出现KIX path building failed</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#抽取出公用的api和实体类"><span class="nav-number">3.9.</span> <span class="nav-text">抽取出公用的api和实体类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#80端口被占用"><span class="nav-number">3.10.</span> <span class="nav-text">80端口被占用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linux安装wget"><span class="nav-number">3.11.</span> <span class="nav-text">linux安装wget</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linux配置网卡"><span class="nav-number">3.12.</span> <span class="nav-text">linux配置网卡</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#yum"><span class="nav-number">3.13.</span> <span class="nav-text">yum</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改阿里的yum源"><span class="nav-number">3.14.</span> <span class="nav-text">修改阿里的yum源</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linux安装JDK"><span class="nav-number">3.15.</span> <span class="nav-text">linux安装JDK</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linux安装maven"><span class="nav-number">3.16.</span> <span class="nav-text">linux安装maven</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linux安装rabbitMQ"><span class="nav-number">3.17.</span> <span class="nav-text">linux安装rabbitMQ</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linux安装nacos"><span class="nav-number">3.18.</span> <span class="nav-text">linux安装nacos</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#linux安装mysql"><span class="nav-number">3.19.</span> <span class="nav-text">linux安装mysql</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Eureka"><span class="nav-number">4.</span> <span class="nav-text">Eureka</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#单机版Eureka服务端"><span class="nav-number">4.1.</span> <span class="nav-text">单机版Eureka服务端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单机版Eureka客户端"><span class="nav-number">4.2.</span> <span class="nav-text">单机版Eureka客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#单机版和集群版的比较"><span class="nav-number">4.3.</span> <span class="nav-text">单机版和集群版的比较</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群版Eureka服务器"><span class="nav-number">4.4.</span> <span class="nav-text">集群版Eureka服务器</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#修改hosts不生效解决方法"><span class="nav-number">4.4.1.</span> <span class="nav-text">修改hosts不生效解决方法</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群版Eureka客户端"><span class="nav-number">4.5.</span> <span class="nav-text">集群版Eureka客户端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#集群版服务提供者"><span class="nav-number">4.6.</span> <span class="nav-text">集群版服务提供者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#微服务主机信息和ip信息的配置"><span class="nav-number">4.7.</span> <span class="nav-text">微服务主机信息和ip信息的配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务发现"><span class="nav-number">4.8.</span> <span class="nav-text">服务发现</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#自我保护"><span class="nav-number">4.9.</span> <span class="nav-text">自我保护</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Ribbon"><span class="nav-number">5.</span> <span class="nav-text">Ribbon</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#修改默认的负载均衡算法"><span class="nav-number">5.1.</span> <span class="nav-text">修改默认的负载均衡算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Ribbon负载均衡算法"><span class="nav-number">5.2.</span> <span class="nav-text">Ribbon负载均衡算法</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenFeign"><span class="nav-number">6.</span> <span class="nav-text">OpenFeign</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本使用"><span class="nav-number">6.1.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#超时机制"><span class="nav-number">6.2.</span> <span class="nav-text">超时机制</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#日志记录"><span class="nav-number">6.3.</span> <span class="nav-text">日志记录</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix"><span class="nav-number">7.</span> <span class="nav-text">Hystrix</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本概念"><span class="nav-number">7.1.</span> <span class="nav-text">基本概念</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务降级"><span class="nav-number">7.2.</span> <span class="nav-text">服务降级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#全局服务降级"><span class="nav-number">7.3.</span> <span class="nav-text">全局服务降级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Feign支持的松耦合服务降级"><span class="nav-number">7.4.</span> <span class="nav-text">Feign支持的松耦合服务降级</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务熔断"><span class="nav-number">7.5.</span> <span class="nav-text">服务熔断</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Gateway"><span class="nav-number">8.</span> <span class="nav-text">Gateway</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务搭建"><span class="nav-number">8.1.</span> <span class="nav-text">服务搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#编码方式配置路由"><span class="nav-number">8.2.</span> <span class="nav-text">编码方式配置路由</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通过微服务名实现动态路由"><span class="nav-number">8.3.</span> <span class="nav-text">通过微服务名实现动态路由</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Config"><span class="nav-number">9.</span> <span class="nav-text">Config</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#读取远程仓库的配置文件"><span class="nav-number">9.1.</span> <span class="nav-text">读取远程仓库的配置文件</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置中心的搭建"><span class="nav-number">9.2.</span> <span class="nav-text">配置中心的搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#其他服务访问配置中心"><span class="nav-number">9.3.</span> <span class="nav-text">其他服务访问配置中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#手动刷新其他服务的配置"><span class="nav-number">9.4.</span> <span class="nav-text">手动刷新其他服务的配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Bus"><span class="nav-number">10.</span> <span class="nav-text">Spring Cloud Bus</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本原理"><span class="nav-number">10.1.</span> <span class="nav-text">基本原理</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#通知配置中心，实现配置的自动刷新"><span class="nav-number">10.2.</span> <span class="nav-text">通知配置中心，实现配置的自动刷新</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#定点通知"><span class="nav-number">10.3.</span> <span class="nav-text">定点通知</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Spring-Cloud-Stream"><span class="nav-number">11.</span> <span class="nav-text">Spring Cloud Stream</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#通信模型"><span class="nav-number">11.1.</span> <span class="nav-text">通信模型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建生产者"><span class="nav-number">11.2.</span> <span class="nav-text">构建生产者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#构建消费者"><span class="nav-number">11.3.</span> <span class="nav-text">构建消费者</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#分组解决重复消费问题"><span class="nav-number">11.4.</span> <span class="nav-text">分组解决重复消费问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#持久化问题"><span class="nav-number">11.5.</span> <span class="nav-text">持久化问题</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sleuth"><span class="nav-number">12.</span> <span class="nav-text">Sleuth</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本使用-1"><span class="nav-number">12.1.</span> <span class="nav-text">基本使用</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Nacos"><span class="nav-number">13.</span> <span class="nav-text">Nacos</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#服务提供者搭建"><span class="nav-number">13.1.</span> <span class="nav-text">服务提供者搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#服务消费者搭建"><span class="nav-number">13.2.</span> <span class="nav-text">服务消费者搭建</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置中心"><span class="nav-number">13.3.</span> <span class="nav-text">配置中心</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#配置的隔离"><span class="nav-number">13.4.</span> <span class="nav-text">配置的隔离</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Nacos集群"><span class="nav-number">13.5.</span> <span class="nav-text">Nacos集群</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Sentinel"><span class="nav-number">14.</span> <span class="nav-text">Sentinel</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#基本使用-2"><span class="nav-number">14.1.</span> <span class="nav-text">基本使用</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流控规则"><span class="nav-number">14.2.</span> <span class="nav-text">流控规则</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#SentinelResource"><span class="nav-number">14.3.</span> <span class="nav-text">SentinelResource</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#fallback和blockHandler"><span class="nav-number">14.4.</span> <span class="nav-text">fallback和blockHandler</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#持久化配置"><span class="nav-number">14.5.</span> <span class="nav-text">持久化配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#seata"><span class="nav-number">15.</span> <span class="nav-text">seata</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#server端配置"><span class="nav-number">15.1.</span> <span class="nav-text">server端配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#client端配置"><span class="nav-number">15.2.</span> <span class="nav-text">client端配置</span></a></li></ol></li></ol></div>
            

            
            
          </div>
        </div>
      <!--/noindex-->
      


    </div>
  </aside>
  
  

  <div id="sidebar-dimmer"></div>
 


      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="copyright">  <a href="http://www.beian.miit.gov.cn" rel="noopener" target="_blank">粵ICP备19091267号 </a>&copy; 2019 – <span itemprop="copyrightYear">2022</span>
  <span class="with-love" id="animate">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Kim.Zhang</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    <span title="站点总字数">629k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    <span title="站点阅读时长">9:32</span>
</div>


<div class="busuanzi-count">
  <script async="" src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item-icon">
      本站总访问量 
    </span>
    <span class="site-uv" title="总访客量">
      <span class="busuanzi-value" id="busuanzi_value_site_uv">4</span>
    </span>
    <span> 次 </span>
    <span class="post-meta-divider">|</span>
  
    <span class="post-meta-item-icon">
      有 
    </span>
    <span class="site-pv" title="总访问量">
      <span class="busuanzi-value" id="busuanzi_value_site_pv">309</span>
    </span>
    <span> 人看我的博客啦 </span>
  <span class="post-meta-divider">|</span>
  <div class="powered-by"></div>
  <span class="post-count">博客全站共176.7k字</span>
</div>


<div>
<span id="timeDate">载入天数...</span><span id="times">载入时分秒...</span>
<script>
    var now = new Date();
    function createtime() {
        var grt= new Date("08/08/2019 14:00:00");
        now.setTime(now.getTime()+250);
        days = (now - grt ) / 1000 / 60 / 60 / 24; dnum = Math.floor(days);
        hours = (now - grt ) / 1000 / 60 / 60 - (24 * dnum); hnum = Math.floor(hours);
        if(String(hnum).length ==1 ){hnum = "0" + hnum;} minutes = (now - grt ) / 1000 /60 - (24 * 60 * dnum) - (60 * hnum);
        mnum = Math.floor(minutes); if(String(mnum).length ==1 ){mnum = "0" + mnum;}
        seconds = (now - grt ) / 1000 - (24 * 60 * 60 * dnum) - (60 * 60 * hnum) - (60 * mnum);
        snum = Math.round(seconds); if(String(snum).length ==1 ){snum = "0" + snum;}
        document.getElementById("timeDate").innerHTML = "本站已安全运行 "+dnum+" 天 ";
        document.getElementById("times").innerHTML = hnum + " 小时 " + mnum + " 分 " + snum + " 秒";
    }
setInterval("createtime()",250);
</script>
</div>




  
  

        








        
      </div>
    </footer>
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>

    
  
  <div id="needsharebutton-float">
    <span class="btn">
      <i class="fa fa-share-alt" aria-hidden="true"></i>
    </span>
  </div>
<script src="/lib/needsharebutton/needsharebutton.js"></script>
<script>
    pbOptions = {};
      pbOptions.iconStyle = "box";
    
      pbOptions.boxForm = "horizontal";
    
      pbOptions.position = "bottomCenter";
    
      pbOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
    
    new needShareButton('#needsharebutton-postbottom', pbOptions);
    flOptions = {};
      flOptions.iconStyle = "box";
    
      flOptions.boxForm = "horizontal";
    
      flOptions.position = "middleRight";
    
      flOptions.networks = "Weibo,Wechat,Douban,QQZone,Twitter,Facebook";
    
    new needShareButton('#needsharebutton-float', flOptions);
</script>


  </div>

  
    
    
  
  <script color='0,0,255' opacity='0.5' zIndex='-1' count='99' src="/lib/canvas-nest/canvas-nest.min.js"></script>
  <script src="/lib/jquery/index.js?v=3.4.1"></script>
  <script src="/lib/fancybox/source/jquery.fancybox.pack.js"></script>
  <script src="/lib/reading_progress/reading_progress.js"></script>
  <script src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  <script src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

<script src="/js/utils.js?v=7.3.0"></script>
  <script src="/js/motion.js?v=7.3.0"></script>


  <script src="/js/affix.js?v=7.3.0"></script>
  <script src="/js/schemes/pisces.js?v=7.3.0"></script>


<script src="/js/next-boot.js?v=7.3.0"></script>






  


  <script src="/lib/bookmark/bookmark.min.js?v=1.0"></script>
  <script>
  if (CONFIG.page.isPost) {
    bookmark.scrollToMark('auto', "#更多");
  } else {
    bookmark.loadBookmark();
  }
  </script>













  <script src="/js/local-search.js?v=7.3.0"></script>














  

  

  


  
  <script src="/js/scrollspy.js?v=7.3.0"></script>
<script src="/js/post-details.js?v=7.3.0"></script>


</body>
<script type="text/javascript" src="/js/clicklove.js"></script>
</html>
